## 1. はじめに

本チュートリアルでは、NocoBase上でCRMの商談転換機能を実装する手順を段階的に解説します。必要なコレクションの作成、データ管理ページの設定、転換プロセスの設計、そして各データの関連付け管理を通して、ビジネスプロセス全体を構築する方法を学びます。

🎉 [NocoBase の CRM ソリューションがついに公開されました](https://www.nocobase.com/ja/blog/crm-solution)

## 2. 準備：必要なコレクションの作成

開始前に、以下の4つのコレクションを用意し、それぞれの間のリレーションシップを設定する必要があります。

### 2.1 リードコレクション (Lead)

このコレクションは、潜在顧客の情報を格納するために使用します。フィールドの定義は以下の通りです:


| Field Name     | Display Name       | Field Interface  | 説明                                                                                |
| -------------- | ------------------ | ---------------- | ----------------------------------------------------------------------------------- |
| id             | **ID**             | Integer          | 主キー                                                                              |
| account_id     | **取引先ID**       | Integer          | 取引先への外部キー                                                                  |
| contact_id     | **取引先責任者ID** | Integer          | 取引先責任者への外部キー                                                            |
| opportunity_id | **商談ID**         | Integer          | 商談への外部キー                                                                    |
| name           | **リード名**       | Single line text | 潜在顧客の名前                                                                      |
| company        | **会社**           | Single line text | 潜在顧客の会社名                                                                    |
| email          | **メール**         | Email            | 潜在顧客のメールアドレス                                                            |
| phone          | **電話番号**       | Phone            | 連絡先電話番号                                                                      |
| status         | **ステータス**     | Single select    | リードの現在の状態 (未認定、新規リード、処理中、フォローアップ中、取引中、完了済み) |
| Account        | **取引先**         | Many to one      | Companyコレクションとの関連付け                                                     |
| Contact        | **取引先責任者**   | Many to one      | Contactコレクションとの関連付け                                                     |
| Opportunity    | **商談**           | Many to one      | Opportunityコレクションとの関連付け                                                 |

### 2.2 アカウントコレクション (Company)

このコレクションは、企業に関する詳細情報を格納するために使用します。フィールドの構成は以下の通りです:


| Field Name | Display Name     | Field Interface  | 説明                               |
| ---------- | ---------------- | ---------------- | ---------------------------------- |
| name       | **取引先名**     | Single line text | アカウント名（会社名または組織名） |
| industry   | **業種**         | Single select    | 企業の業界                         |
| phone      | **電話番号**     | Phone            | 企業の連絡先電話番号               |
| website    | **ウェブサイト** | URL              | 企業の公式ウェブサイトのURL        |

### 2.3 コンタクトコレクション (Contact)

このコレクションは、連絡先情報を格納するためのものです。フィールドは以下の通りです:


| Field Name | Display Name | Field Interface  | 説明                   |
| ---------- | ------------ | ---------------- | ---------------------- |
| name       | **氏名**     | Single line text | 連絡先の名前           |
| email      | **メール**   | Email            | 連絡先のメールアドレス |
| phone      | **電話番号** | Phone            | 連絡先の電話番号       |

### 2.4 オポチュニティコレクション (Opportunity)

このコレクションは、商談に関する情報を記録するために使用します。フィールドの定義は以下の通りです:


| Field Name | Display Name     | Field Interface  | 説明                                                                |
| ---------- | ---------------- | ---------------- | ------------------------------------------------------------------- |
| name       | **商談名**       | Single line text | 商談の名称                                                          |
| stage      | **商談ステージ** | Single select    | 商談の段階 (資格審査中、要件定義、提案、交渉、契約成立、成功、失敗) |
| amount     | **金額**         | Number           | 商談の金額                                                          |
| close_date | **クローズ日**   | Datetime         | 商談の予想締結日                                                    |

## 3. 商談転換プロセスの理解

### 3.1 一般的な転換プロセスの概要

リードから商談へ転換する際は、通常、以下のプロセスを経ます:

![20250225211802](https://static-docs.nocobase.com/20250225211802.png)

### 3.2 関係性の説明

上記の4つのコレクションを作成し、各コレクション間のマッピング関係を正しく設定していれば:

![Relationships](https://static-docs.nocobase.com/20250225090913.png)

## 4. データ管理ページの作成

NocoBaseのワークスペース内で、各コレクションのデータ管理ページを作成し、後続のテスト用にサンプルリードデータを追加します。

![Data Management Page](https://static-docs.nocobase.com/20250224234721.png)

## 5. 商談転換機能の実装

本セクションでは、リードを会社、連絡先、商談の各レコードに転換する方法と、転換操作が重複して実行されないようにする方法について解説します。

### 5.1 「転換」編集操作の作成

リード詳細ビューにおいて、「転換」という名前の編集操作を作成します。転換用モーダルでは、以下の項目を設定します:

#### 5.1.1 リード基本情報の表示

現在のリード基本情報を読み取り専用で表示し、ユーザーが誤って元データを変更しないようにします。

#### 5.1.2 関連付けフィールドの表示

モーダル内に以下の3つの関連付けフィールドを表示し、各フィールドで「クイック作成」機能を有効にします。これにより、該当レコードが存在しない場合に即座に新規データを作成できるようになります。

![Display Associated Fields](https://static-docs.nocobase.com/20250224234155.png)

#### 5.1.3 クイック作成のデフォルトマッピング設定

「クイック作成」モーダル設定において、各関連付けフィールドのデフォルト値を設定し、リード情報が自動的に対象コレクションへマッピングされるようにします。マッピングルールは以下の通り、Salesforceの転換機能に合わせて修正しています:

- リード/会社 → 会社/取引先名
- リード/電話 → 会社/電話番号
- リード/リード名 → 連絡先/氏名
- リード/メール → 連絡先/メール
- リード/電話 → 連絡先/電話番号
- リード/会社 → 商談/商談名
- 定数「資格審査中」 → 商談/商談ステージ

設定例のスクリーンショット:

![Default Mapping 1](https://static-docs.nocobase.com/20250225000218.png)
![Default Mapping 2](https://static-docs.nocobase.com/20250225001256.png)

#### 5.1.4 転換効果の確認

設定完了後、転換操作が実行されると、システムはマッピングルールに従って会社、連絡先、商談の各レコードを新たに作成および関連付けします。下記の動作例をご覧ください:

![](https://static-docs.nocobase.com/202502252130-transfer1.gif)

次に、送信操作に送信成功のフィードバックを追加します：
![20250226154935](https://static-docs.nocobase.com/20250226154935.png)
![20250226154952](https://static-docs.nocobase.com/20250226154952.png)

送信結果：
![](https://static-docs.nocobase.com/202502252130-transfer2.gif)

### 5.2 重複転換の防止

同じリードが複数回転換されるのを防ぐため、以下の方法で制御を行います:

#### 5.2.1 リードステータスの更新

転換フォーム送信操作に自動データ更新ステップを追加し、リードのステータスを「転換済み」に変更します。

設定例のスクリーンショット:

![Update Status 1](https://static-docs.nocobase.com/20250225001758.png)
![Update Status 2](https://static-docs.nocobase.com/20250225001817.png)
動作例:
![Conversion Effect](https://static-docs.nocobase.com/202502252130-transfer.gif)

#### 5.2.2 ボタン連動ルールの設定

転換ボタンに対して、リードのステータスが「転換済み」の場合、自動的に非表示となる連動ルールを設定し、重複操作を防ぎます。

設定例のスクリーンショット:

![Button Linking 1](https://static-docs.nocobase.com/20250225001838.png)
![Button Linking 2](https://static-docs.nocobase.com/20250225001939.png)
![Button Linking 3](https://static-docs.nocobase.com/20250225002026.png)

## 6. 詳細ページにおける関連付け管理ブロックの設定

各コレクションの詳細ページ上で関連データを閲覧できるよう、該当するリストブロックまたは詳細ブロックの設定を行います。

### 6.1 会社コレクション詳細ページの設定

会社の詳細ページ（例：連絡先の編集/詳細モーダル内）には、以下のリストブロックを追加します:

- 連絡先リストブロック
- 商談リストブロック
- リードリストブロック

設定例のスクリーンショット:

![Company Detail Page](https://static-docs.nocobase.com/20250225085418.png)

### 6.2 フィルター条件の追加

各リストブロックに対して、現在の会社IDに関連するデータのみが表示されるようフィルター条件を追加します。

設定例のスクリーンショット:

![Filter Condition 1](https://static-docs.nocobase.com/20250225085513.png)
![Filter Condition 2](https://static-docs.nocobase.com/20250225085638.png)

### 6.3 連絡先・商談詳細ページの設定

連絡先コレクションの詳細モーダルには、以下のブロックを追加します:

- 商談リストブロック
- 会社詳細ブロック
- リードリストブロック（IDでフィルタ）

設定例のスクリーンショット:

![Contact Detail](https://static-docs.nocobase.com/20250225090231.png)

商談詳細ページでも、次のブロックを追加します:

- 連絡先リストブロック
- 会社詳細ブロック
- リードリストブロック（IDでフィルタ）

設定例のスクリーンショット:

![Opportunity Detail](https://static-docs.nocobase.com/20250225091208.png)

## 7. 結論

以上の手順により、簡易的なCRM商談転換機能を実装し、連絡先、会社、リード間の関連付け管理を構築することができました。本チュートリアルが、ビジネスプロセス全体の理解および構築に役立ち、システムの利便性および効率的な運用に貢献することを願っています。

---

操作中に問題が発生した場合は、[NocoBase コミュニティ](https://forum.nocobase.com/c/japanese-forum/7)に参加するか、公式ドキュメント（[日文ドキュメントセンター](https://docs-jp.nocobase.com)）をご参照ください。
本ガイドが、実際のニーズに応じたユーザー登録審査の実装と、必要に応じた柔軟な拡張に役立つことを願っています。
スムーズなご利用とプロジェクトの成功をお祈りします！
