## 1. Введение

### 1.1 Цель главы

В этой главе мы научимся реализовывать конвертацию лидов CRM в NocoBase. Благодаря сопровождению лидов и управлению статусами вы сможете повысить операционную эффективность и добиться более тонкого контроля над процессом продаж.

### 1.2 Предварительный просмотр конечного результата

В предыдущей главе мы объяснили, как связать данные между лидами и коллекциями Компаний, Контактов и Возможностей. Теперь мы сосредоточимся на модуле Лидов, в основном обсуждая, как осуществлять сопровождение лидов и управление статусами. Пожалуйста, посмотрите следующую демонстрацию:
![](https://static-docs.nocobase.com/202502250226-transfer3.gif)

## 2. Структура коллекции Лидов

### 2.1 Введение в коллекцию Лидов

В функциональности сопровождения лидов поле "статус" играет ключевую роль. Оно не только отражает текущий прогресс лида (например, Невалидный, Новый, В работе, В развитии, В сделке, Завершен), но и управляет динамическим отображением и изменениями формы. Следующая таблица показывает структуру полей коллекции Лидов вместе с ее подробным описанием:

| Название поля     | Отображаемое имя | Интерфейс поля   | Описание                                                                             |
| ----------------- | ---------------- | ---------------- | ------------------------------------------------------------------------------------ |
| id                | **Id**           | Целое число      | Первичный ключ                                                                       |
| account_id        | **account_id**   | Целое число (Integer)      | Внешний ключ коллекции АККАУНТОВ (COMPANY)                                           |
| contact_id        | **contact_id**   | Целое число (Integer)       | Внешний ключ коллекции КОНТАКТОВ (CONTACT)                                           |
| opportunity_id    | **opportunity_id** | Целое число (Integer)   | Внешний ключ коллекции ВОЗМОЖНОСТЕЙ (OPPORTUNITY)                                    |
| name              | **Имя лида**     | Строка | Имя потенциального клиента                                                           |
| company           | **Название компании** | Строка | Название компании потенциального клиента                                         |
| email             | **Email**        | Email            | Адрес электронной почты потенциального клиента                                       |
| phone             | **Контактный номер** | Телефон       | Контактный номер                                                                     |
| status            | **Статус**       | Одиночный выбор  | Текущий статус лида (Невалидный, Новый, В работе, В развитии, В сделке, Завершен) |
| Account           | **Компания**     | Многие к одному  | Связь с коллекцией Компаний                                                          |
| Contact           | **Контакт**      | Многие к одному  | Связь с коллекцией Контактов                                                         |
| Opportunity       | **Возможность**  | Многие к одному  | Связь с коллекцией Возможностей                                                      |

## 3. Создание табличного блока Лидов и блока деталей

### 3.1 Инструкция по созданию

Сначала нам нужно создать табличный блок "Лиды" для отображения необходимых полей. Одновременно настройте блок деталей в правой части страницы, чтобы при нажатии на запись автоматически отображались соответствующие детали. Пожалуйста, обратитесь к демонстрации ниже:
![](https://static-docs.nocobase.com/20250226090009.png)

## 4. Настройка кнопок действий

### 4.1 Общее описание кнопок

Чтобы удовлетворить различные операционные потребности, нам нужно создать в общей сложности 11 кнопок. Каждая кнопка будет отображаться по-разному (скрыта, активна или неактивна) в зависимости от статуса записи, направляя пользователя по правильному бизнес-процессу.
![](https://static-docs.nocobase.com/20250226173632.png)

### 4.2 Детальная конфигурация для каждой функциональной кнопки

#### 4.2.1 Кнопка Редактировать

- Правило связи: Когда статус записи "Завершен", эта кнопка автоматически отключается, чтобы предотвратить ненужное редактирование.

#### 4.2.2 Кнопка Неверный 1 (Неактивная)

- Внешний вид: Заголовок отображается как "Невалидный >".
- Операция: При нажатии выполняется операция обновления, которая устанавливает статус записи в "Невалидный". После успешного обновления вернуться на предыдущую страницу и отобразить сообщение об успехе для "Невалидный".
- Правило связи: Отображается только когда статус записи пуст; как только статус установлен, кнопка автоматически скрывается.

#### 4.2.3 Кнопка Неверный 2 (Активная)

- Внешний вид: Также отображается как "Невалидный >".
- Операция: Используется для обновления статуса записи на "Невалидный".
- Правило связи: Скрыта, когда статус пуст; если статус "Завершен", кнопка отключается.

#### 4.2.4 Кнопка Новый 1 (Неактивная)

- Внешний вид: Заголовок отображается как "Новый >".
- Операция: При нажатии обновить запись, установив статус в "Новый" и, в случае успеха, отобразить сообщение об успехе "Новый".
- Правило связи: Если статус записи уже "Новый", "В работе", "В развитии" или "Завершен", кнопка скрывается.

#### 4.2.5 Кнопка Новый 2 (Активная)

- Внешний вид: Заголовок остается "Новый >".
- Операция: Также используется для обновления статуса записи на "Новый".
- Правило связи: Скрыта, когда статус "Невалидный" или пуст; если статус "Завершен", кнопка отключается.

#### 4.2.6 Кнопка В работе (Неактивная)

- Внешний вид: Заголовок отображается как "В работе >".
- Операция: При нажатии обновить статус записи на "В работе" и отобразить сообщение об успехе "В работе".
- Правило связи: Если статус записи уже "В работе", "В развитии" или "Завершен", кнопка скрывается.

#### 4.2.7 Кнопка В работе (Активная)

- Внешний вид: Заголовок остается "В работе >".
- Операция: Используется для обновления статуса записи на "В работе".
- Правило связи: Скрыта, когда статус "Невалидный", "Новый" или пуст; если статус "Завершен", кнопка отключается.

#### 4.2.8 Кнопка В развитии (Неактивная)

- Внешний вид: Заголовок отображается как "В развитии >".
- Операция: При нажатии обновить статус записи на "В развитии" и отобразить сообщение об успехе "В развитии".
- Правило связи: Если статус записи уже "В развитии" или "Завершен", кнопка скрывается.

#### 4.2.9 Кнопка В развитии (Активная)

- Внешний вид: Заголовок остается "В развитии >".
- Операция: Также используется для обновления статуса записи на "В развитии".
- Правило связи: Скрыта, когда статус "Невалидный", "Новый", "В работе" или пуст; если статус "Завершен", кнопка отключается.

#### 4.2.10 Кнопка Конвертировать

- Внешний вид: Заголовок отображается как "конвертировать" и открывается в модальном окне.
- Операция: В основном используется для выполнения операции переноса записи. После обновления система отобразит интерфейс с выдвижной панелью, вкладками и формой для облегчения переноса.
- Правило связи: Когда статус записи "Завершен", эта кнопка скрыта, чтобы предотвратить дублирующие конвертации.
  ![](https://static-docs.nocobase.com/20250226094223.png)

#### 4.2.11 Кнопка Сконвертирован (Активная)

- Внешний вид: Заголовок отображается как "сконвертирован" и также открывается в модальном окне.
- Операция: Эта кнопка используется только для отображения информации после завершения конвертации и не позволяет редактировать.
- Правило связи: Отображается только когда статус записи "Завершен"; она скрыта для статусов "Невалидный", "Новый", "В работе", "В развитии" или когда пусто.
  ![](https://static-docs.nocobase.com/20250226094203.png)

### 4.3 Итог по конфигурациям кнопок

- Каждая функция предоставляет разные стили кнопок для неактивного и активного состояний.
- Правила связи динамически управляют отображением (скрыты или отключены) кнопок на основе статуса записи, направляя торговый персонал по правильному рабочему процессу.

## 5. Настройки правил связи форм

### 5.1 Правило 1: Отображать только имя

- Когда запись не подтверждена или статус пуст, отображается только имя.
  ![](https://static-docs.nocobase.com/20250226092629.png)
  ![](https://static-docs.nocobase.com/20250226092555.png)

### 5.2 Правило 2: Оптимизированное отображение при статусе "Новый"

- Когда статус "Новый", название компании скрыто, а контактная информация отображается.
  ![](https://static-docs.nocobase.com/20250226092726.png)

## 6. Правила Markdown на странице и синтаксис Handlebars

### 6.1 Динамическое отображение текста

На странице мы используем синтаксис Handlebars для динамического отображения различных сообщений-подсказок в зависимости от статуса записи. Ниже приведены примеры кода для каждого статуса:

Когда статус "Невалидный":

```markdown
{{#if (eq $nRecord.status "Unqualified")}}
**Отслеживайте детали ваших невалидных лидов.**
Если ваш лид не заинтересован в продукте или покинул связанную компанию, он может быть помечен как невалидный.
- Записывайте извлеченные уроки для будущего использования
- Сохраняйте детали взаимодействия и контактную информацию
{{/if}}
```

Когда статус "Новый":

```markdown
{{#if (eq $nRecord.status "New")}}
**Определите продукты или услуги, необходимые для этой возможности.**
- Соберите кейсы клиентов, справочные материалы или анализы конкурентов
- Подтвердите ваших ключевых стейкхолдеров
- Определите доступные ресурсы
{{/if}}
```

Когда статус "В работе":

```markdown
{{#if (eq $nRecord.status "Working")}}
**Представьте ваше решение стейкхолдерам.**
- Объясните ценность вашего решения
- Уточните сроки и бюджеты
- Разработайте с клиентом план, когда и как закрыть сделку
{{/if}}
```

Когда статус "В развитии":

```markdown
{{#if (eq $nRecord.status "Nurturing")}}
**Определите план реализации проекта клиента.**
- Достигайте соглашений по мере необходимости
- Следуйте внутреннему процессу скидок
- Получите подписанный контракт
{{/if}}
```

Когда статус "Завершен":

```markdown
{{#if (eq $nRecord.status "Completed")}}
**Подтвердите план реализации проекта и финальные шаги.**
- Убедитесь, что все оставшиеся соглашения и процедуры подписания на месте
- Соблюдайте внутреннюю политику скидок
- Убедитесь, что контракт подписан и проект продолжается по плану
{{/if}}
```

## 7. Отображение связанных объектов и переход по ссылкам после конвертации

### 7.1 Описание связанных объектов

После конвертации мы хотим отображать связанные объекты (Компания, Контакт, Возможность) вместе со ссылками на их страницы деталей. Примечание: В других всплывающих окнах или страницах последняя часть ссылки на детали (после filterbytk) представляет собой id текущего объекта. Например:

```url
http://localhost:13000/apps/tsting/admin/w3yyu23uro0/popups/ki0wcnfruj6/filterbytk/1
```

### 7.2 Генерация связанных ссылок с использованием Handlebars

Для Компании:

```markdown
{{#if (eq $nRecord.status "Completed")}}
**Компания:**
[{{$nRecord.account.name}}](http://localhost:13000/apps/tsting/admin/w3yyu23uro0/popups/ki0wcnfruj6/filterbytk/{{$nRecord.account_id}})
{{/if}}
```

Для Контакта:

```markdown
{{#if (eq $nRecord.status "Completed")}}
**Контакт:**
[{{$nRecord.contact.name}}](http://localhost:13000/apps/tsting/admin/1oqybfwrocb/popups/8bbsqy5bbpl/filterbytk/{{$nRecord.contact_id}})
{{/if}}
```

Для Возможности:

```markdown
{{#if (eq $nRecord.status "Completed")}}
**Возможность:**
[{{$nRecord.opportunity.name}}](http://localhost:13000/apps/tsting/admin/si0io9rt6q6/popups/yyx8uflsowr/filterbytk/{{$nRecord.opportunity_id}})
{{/if}}
```

![](https://static-docs.nocobase.com/20250226093501.png)

## 8. Скрытие связанных объектов с сохранением их значений

Чтобы обеспечить правильное отображение связанной информации после конвертации, статусы для полей "Компания", "Контакт" и "Возможность" должны быть установлены в "скрытый (сохранять значение)". Таким образом, даже если эти поля не отображаются в форме, их значения все равно записываются и передаются.
![](https://static-docs.nocobase.com/20250226093906.png)

## 9. Предотвращение изменения статуса после конвертации

Чтобы предотвратить случайное изменение статуса после конвертации, мы добавляем условие ко всем кнопкам: когда статус "Завершен", все кнопки будут отключены.
![](https://static-docs.nocobase.com/20250226094302.png)

## 10. Заключение

После выполнения всех вышеперечисленных шагов функциональность конвертации лидов готова! Следуя этому пошаговому руководству, мы надеемся, что вы получили более четкое понимание того, как реализуется динамика форм и связи на основе статусов в NocoBase. Желаем вам беспроблемной работы и приятного опыта!