<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo Config Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f0f0f0;
            font-size: 13px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 10px;
        }

        .header {
            background: white;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
        }

        .header h1 {
            margin-bottom: 5px;
            font-size: 18px;
        }

        .header p {
            font-size: 12px;
        }

        .main-content {
            display: flex;
            gap: 10px;
            height: calc(100vh - 120px);
            min-height: 400px;
        }

        .left-panel {
            width: 250px;
            background: white;
            border: 1px solid #ddd;
            display: flex;
            flex-direction: column;
        }

        .center-panel {
            flex: 1;
            background: white;
            border: 1px solid #ddd;
            display: flex;
            flex-direction: column;
        }

        .right-panel {
            width: 300px;
            background: white;
            border: 1px solid #ddd;
            display: flex;
            flex-direction: column;
        }

        .steps-container {
            flex: 1;
            overflow-y: auto;
            padding: 5px;
        }

        .steps-header {
            padding: 8px;
            border-bottom: 1px solid #ddd;
            background: #f5f5f5;
        }

        .steps-header h3 {
            margin: 0;
            font-size: 14px;
        }

        .step-item {
            margin-bottom: 3px;
            padding: 3px;
            border: 1px solid #ddd;
            background: #f9f9f9;
            cursor: pointer;
        }

        .step-item.active {
            border-color: #007bff;
            background: #e6f3ff;
        }

        .step-item.pending {
            border: 1px dashed #666;
            background: #f0f0f0;
        }

        .step-item.chapter {
            border-color: #6c757d;
            background: #f8f9fa;
        }

        .step-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2px;
            font-size: 10px;
        }

        .step-item-header div {
            display: flex;
            gap: 2px;
        }

        .step-item-header button {
            padding: 0px 4px;
            font-size: 10px;
            line-height: 1.2;
            min-width: 16px;
            height: 16px;
        }

        .step-item input {
            width: 100%;
            padding: 1px 2px;
            margin-bottom: 1px;
            border: 1px solid #ccc;
            font-size: 9px;
        }

        .step-item select {
            width: 100%;
            padding: 1px;
            border: 1px solid #ccc;
            font-size: 9px;
            margin-bottom: 1px;
        }

        .step-item button {
            padding: 1px 2px;
            font-size: 9px;
            border: 1px solid #ccc;
            background: #f5f5f5;
            cursor: pointer;
        }

        .step-button-config input,
        .step-button-config select {
            padding: 3px 5px;
            font-size: 11px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        .add-step-btn {
            width: 100%;
            padding: 12px;
            border: 2px dashed #28a745;
            background: #f8fff9;
            color: #28a745;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 8px;
            transition: all 0.2s;
        }

        .add-step-btn:hover {
            background: #e8f5e8;
            border-color: #1e7e34;
            color: #1e7e34;
        }

        .image-container {
            position: relative;
            flex: 1;
            overflow: hidden;
            background: #f8f9fa;
            border-radius: 8px 8px 0 0;
        }

        .image-display {
            width: 100%;
            height: 100%;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: auto;
        }

        .demo-image {
            max-width: 100%;
            max-height: 100%;
            border-radius: 4px;
            cursor: crosshair;
        }

        .marker {
            position: absolute;
            width: 80px;
            height: 80px;
            cursor: pointer;
            z-index: 10;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .marker svg {
            width: 100%;
            height: 100%;
        }

        .marker:hover {
            transform: scale(1.1);
        }

        /* ç« èŠ‚é¡µé¢æ ·å¼ */
        .chapter-display {
            width: 100%;
            height: 100%;
            background: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23e0e0e0' fill-opacity='0.4'%3E%3Cpath d='M20 20c0-11.046-8.954-20-20-20v40c11.046 0 20-8.954 20-20z'/%3E%3C/g%3E%3C/svg%3E") center center repeat;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .chapter-display:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .chapter-content {
            text-align: center;
            max-width: 600px;
            padding: 10%;
            position: relative;
        }

        .chapter-content::after {
            content: 'ç‚¹å‡»ç»§ç»­';
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            opacity: 0.8;
            animation: chapterPulse 2s infinite;
        }

        @keyframes chapterPulse {
            0%, 100% {
                opacity: 0.6;
                transform: translateX(-50%) scale(1);
            }
            50% {
                opacity: 1;
                transform: translateX(-50%) scale(1.05);
            }
        }

        .chapter-number {
            font-size: 72px;
            font-weight: normal;
            line-height: 1;
            margin-bottom: 0;
            opacity: 0.3;
        }

        .chapter-title {
            font-size: 24px;
            font-weight: normal;
            line-height: 1.3;
            margin-bottom: 0;
            color: #333;
        }

        .toolbar {
            padding: 15px;
            border-top: 1px solid #eee;
            background: #f8f9fa;
            border-radius: 0 0 8px 8px;
        }

        .toolbar-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .toolbar-row:last-child {
            margin-bottom: 0;
        }

        .form-group {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }

        .form-group:last-child {
            border-bottom: none;
        }

        .form-group h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 16px;
        }

        .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .form-row:last-child {
            margin-bottom: 0;
        }

        label {
            min-width: 80px;
            font-weight: 500;
            color: #555;
            font-size: 14px;
        }

        input[type="text"],
        input[type="url"],
        textarea,
        select {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        textarea {
            resize: vertical;
            min-height: 60px;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #1e7e34;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .steps-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .step-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }

        .step-item:hover {
            background: #f8f9fa;
        }

        .step-item.active {
            background: #e3f2fd;
            border-left: 3px solid #2196f3;
        }

        .step-item:last-child {
            border-bottom: none;
        }

        .step-title {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .step-id {
            font-size: 12px;
            color: #666;
        }

        .json-import-export {
            margin-bottom: 15px;
        }

        .json-textarea {
            width: 100%;
            min-height: 120px;
            font-family: monospace;
            font-size: 12px;
        }

        .empty-state {
            text-align: center;
            color: #666;
            padding: 40px;
        }

        .empty-state h3 {
            margin-bottom: 10px;
        }

        .placeholder-text {
            color: #999;
            font-style: italic;
        }

        .position-display {
            font-family: monospace;
            font-size: 12px;
            color: #666;
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .config-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .config-section h4 {
            margin-bottom: 10px;
            color: #333;
            font-size: 14px;
        }

        /* é¢„è§ˆé¢æ¿æ ·å¼ */
        .preview-section {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            flex-shrink: 0;
        }

        .json-section {
            padding: 0;
            overflow-y: auto;
            background: #f8f9fa;
            flex: 1;
            display: flex;
            flex-direction: column;
            border-top: 1px solid #eee;
        }

        .preview-header {
            padding: 8px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .preview-header h3 {
            margin: 0;
            font-size: 12px;
            color: #333;
        }

        .preview-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .preview-controls button {
            padding: 4px 8px;
            font-size: 12px;
        }

        /* å…¨å±é¢„è§ˆæ ·å¼ */
        .fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .fullscreen-overlay.active {
            display: flex;
        }

        .fullscreen-content {
            max-width: 1200px;
            max-height: 90vh;
            width: 90vw;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .fullscreen-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .fullscreen-header h2 {
            margin: 0;
            color: #333;
            font-size: 20px;
        }

        .fullscreen-demo {
            flex: 1;
            padding: 30px;
            overflow: auto;
            background: white;
        }

        .fullscreen-navigation {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-fullscreen {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .close-fullscreen:hover {
            background: #c82333;
        }

        /* å…¨å±æ¼”ç¤ºå†…å®¹æ ·å¼ - æ¨¡ä»¿InteractiveDemo.astro */
        .fullscreen-demo-wrap {
            display: flex;
            flex-direction: column;
            gap: 30px;
            max-width: 100%;
        }

        .fullscreen-demo-container {
            position: relative;
            display: block;
            width: 100%;
            margin: 0 auto;
        }

        .fullscreen-demo-button {
            position: absolute !important;
            width: 80px !important;
            height: 80px !important;
            cursor: pointer !important;
            z-index: 10 !important;
            border-radius: 50% !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            transition: all 0.3s ease !important;
            border: none !important;
            background: none !important;
            padding: 0 !important;
        }

        .fullscreen-demo-button:hover {
            transform: scale(1.1) !important;
        }

        .fullscreen-demo-button svg {
            width: 100% !important;
            height: 100% !important;
        }

        /* å…¨å±æ¨¡å¼ä¸‹çš„æ­¥éª¤ä¿¡æ¯ */
        .fullscreen-step-info {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .fullscreen-step-info h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 20px;
            font-weight: 600;
        }

        .fullscreen-step-info p {
            margin: 0;
            color: #666;
            font-size: 16px;
            line-height: 1.5;
        }

        /* æç¤ºæ¡†æ ·å¼ - å¸¦ç®­å¤´ */
        .demo-button::after,
        .fullscreen-demo-button::after {
            content: attr(aria-label);
            position: absolute;
            background: rgba(250, 84, 28, 0.9);
            color: white;
            padding: 10px 14px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: normal;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            z-index: 100;
            max-width: 200px;
            word-wrap: break-word;
            white-space: normal;
            line-height: 1.4;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.15s ease-out, visibility 0.15s ease-out;
        }

        .demo-button::before,
        .fullscreen-demo-button::before {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.15s ease-out, visibility 0.15s ease-out;
        }

        .demo-button:hover::after,
        .demo-button:hover::before,
        .fullscreen-demo-button:hover::after,
        .fullscreen-demo-button:hover::before {
            opacity: 1;
            visibility: visible;
        }

        /* ä¸Šæ–¹æç¤º */
        .demo-button[data-balloon-pos="up"]::after,
        .fullscreen-demo-button[data-balloon-pos="up"]::after {
            bottom: 100%;
            left: 50%;
            margin-bottom: 8px;
            transform: translateX(-50%);
        }

        .demo-button[data-balloon-pos="up"]::before,
        .fullscreen-demo-button[data-balloon-pos="up"]::before {
            bottom: 100%;
            left: 50%;
            margin-bottom: -2px;
            transform: translateX(-50%);
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid rgba(250, 84, 28, 0.9);
        }

        /* ä¸‹æ–¹æç¤º */
        .demo-button[data-balloon-pos="down"]::after,
        .fullscreen-demo-button[data-balloon-pos="down"]::after {
            top: 100%;
            left: 50%;
            margin-top: 8px;
            transform: translateX(-50%);
        }

        .demo-button[data-balloon-pos="down"]::before,
        .fullscreen-demo-button[data-balloon-pos="down"]::before {
            top: 100%;
            left: 50%;
            margin-top: -2px;
            transform: translateX(-50%);
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid rgba(250, 84, 28, 0.9);
        }

        /* å·¦ä¾§æç¤º */
        .demo-button[data-balloon-pos="left"]::after,
        .fullscreen-demo-button[data-balloon-pos="left"]::after {
            right: 100%;
            top: 50%;
            margin-right: 8px;
            transform: translateY(-50%);
            max-width: 180px;
        }

        .demo-button[data-balloon-pos="left"]::before,
        .fullscreen-demo-button[data-balloon-pos="left"]::before {
            right: 100%;
            top: 50%;
            margin-right: -2px;
            transform: translateY(-50%);
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-left: 8px solid rgba(250, 84, 28, 0.9);
        }

        /* å³ä¾§æç¤º */
        .demo-button[data-balloon-pos="right"]::after,
        .fullscreen-demo-button[data-balloon-pos="right"]::after {
            left: 100%;
            top: 50%;
            margin-left: 8px;
            transform: translateY(-50%);
            max-width: 180px;
        }

        .demo-button[data-balloon-pos="right"]::before,
        .fullscreen-demo-button[data-balloon-pos="right"]::before {
            left: 100%;
            top: 50%;
            margin-left: -2px;
            transform: translateY(-50%);
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-right: 8px solid rgba(250, 84, 28, 0.9);
        }

        .preview-content {
            padding: 8px;
            overflow: auto;
        }

        .preview-demo {
            position: relative;
            background: white;
        }

        .preview-demo img {
            width: 100%;
            height: auto;
            display: block;
        }

        .preview-demo .demo-button {
            position: absolute !important;
            width: 40px !important;
            height: 40px !important;
            cursor: pointer !important;
            z-index: 10 !important;
            border-radius: 50% !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            transition: all 0.3s ease !important;
            border: none !important;
            background: none !important;
            padding: 0 !important;
        }

        .preview-demo .demo-button:hover {
            transform: scale(1.1) !important;
        }

        .preview-demo .demo-button svg {
            width: 100% !important;
            height: 100% !important;
        }

        /* å°é¢„è§ˆçª—å£æ ·å¼æ”¹è¿› */
        .preview-demo-container {
            position: relative;
            width: 100%;
        }

        .preview-step-info {
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e9ecef;
            font-size: 12px;
            line-height: 1.4;
        }

        .preview-step-info strong {
            color: #333;
            font-weight: 600;
        }

        .preview-step-info .text-muted {
            color: #666;
            font-size: 11px;
        }

        .step-navigation {
            padding: 6px 8px;
            border-top: 1px solid #eee;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .step-counter {
            font-size: 12px;
            color: #666;
        }

        .nav-buttons {
            display: flex;
            gap: 5px;
        }

        .nav-buttons button {
            padding: 4px 8px;
            font-size: 12px;
        }

        /* æ‹–æ‹½æ—¶çš„è§†è§‰åé¦ˆ */
        .marker:hover {
            transform: scale(1.1);
            transition: transform 0.2s ease;
        }

        .marker[style*="cursor: grabbing"] {
            transform: scale(1.15);
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
        }

        /* æ­¥éª¤æ‹–æ‹½æ ·å¼ */
        .step-item.dragging {
            opacity: 0.5;
            background: #e3f2fd;
            border: 2px dashed #2196f3;
        }

        .step-item.drag-over {
            border-top: 3px solid #2196f3;
        }

        .drag-handle {
            cursor: move;
            color: #999;
            margin-right: 4px;
            font-size: 12px;
            display: inline-block;
            width: 16px;
            text-align: center;
        }

        .drag-handle:hover {
            color: #333;
        }

        /* æ·»åŠ ç« èŠ‚æŒ‰é’®æ ·å¼ */
        .add-chapter-btn {
            width: 100%;
            padding: 8px;
            border: 2px dashed #6c757d;
            background: #f8f9fa;
            color: #6c757d;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            margin-bottom: 5px;
            transition: all 0.2s;
        }

        .add-chapter-btn:hover {
            background: #e9ecef;
            border-color: #495057;
            color: #495057;
        }

        @media (max-width: 1200px) {
            .main-content {
                flex-direction: column;
                height: auto;
            }
            
            .left-panel {
                width: 100%;
                height: 300px;
                margin-bottom: 15px;
            }
            
            .center-panel {
                width: 100%;
                height: 500px;
            }

            .preview-panel {
                display: none !important;
            }
        }

        /* JSONç¼–è¾‘å™¨æ ·å¼ */
        #jsonEditor:focus {
            outline: none;
            border-color: #0056b3;
            background: #f0f4ff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.1);
        }

        #jsonEditor:hover {
            border-color: #0056b3;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 15px;
            }
            
            .left-panel {
                height: 250px;
            }
            
            .center-panel {
                height: 400px;
            }

            .chapter-content::after {
                font-size: 12px;
                padding: 6px 12px;
                bottom: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Demo Config Editor</h1>
            <p>å¯è§†åŒ–ç¼–è¾‘æ¼”ç¤ºé…ç½®JSONæ–‡ä»¶ - ğŸ“‹ <strong>ç²˜è´´å›¾ç‰‡URLåˆ›å»ºæ™®é€šæ­¥éª¤</strong> | ğŸ¯ <strong>ç‚¹å‡»å›¾ç‰‡æ·»åŠ äº¤äº’ç‚¹</strong> | ğŸ“ <strong>åˆ é™¤å›¾ç‰‡URLåˆ›å»ºç« èŠ‚é¡µ</strong> | ğŸ¤ <strong>æ‹–æ‹½è°ƒæ•´åœ†ç‚¹ä½ç½®</strong> | ğŸ—‘ï¸ <strong>Shift+ç‚¹å‡»åˆ é™¤åœ†ç‚¹</strong>
            </p>
        </div>

        <div class="main-content">
            <!-- å·¦ä¾§é¢æ¿ - ç´§å‡‘æ­¥éª¤åˆ—è¡¨ -->
            <div class="left-panel">
                <div class="steps-header">
                    <h3>ğŸ“ æ­¥éª¤åˆ—è¡¨</h3>
                </div>
                <div class="steps-container" id="compactStepsList">
                    <!-- ç´§å‡‘æ­¥éª¤åˆ—è¡¨å°†åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <!-- ä¸­é—´é¢æ¿ - å›¾ç‰‡ç¼–è¾‘åŒº -->
            <div class="center-panel">
                <div class="image-container">
                    <div class="image-display" id="imageDisplay">
                        <div class="empty-state">
                            <h3>å¼€å§‹åˆ›å»ºæ¼”ç¤º</h3>
                            <p>ğŸ’¡ <strong>è¶…ç®€å•æµç¨‹ï¼š</strong></p>
                            <p>1ï¸âƒ£ Ctrl+V ç²˜è´´å›¾ç‰‡é“¾æ¥ â†’ è‡ªåŠ¨åˆ›å»ºæ™®é€šæ­¥éª¤</p>
                            <p>2ï¸âƒ£ ç‚¹å‡»å›¾ç‰‡ä»»æ„ä½ç½® â†’ ç›´æ¥æ·»åŠ äº¤äº’ç‚¹</p>
                            <p>3ï¸âƒ£ åˆ é™¤å›¾ç‰‡URL â†’ å˜æˆç« èŠ‚é¡µ</p>
                            <p>4ï¸âƒ£ æ‹–æ‹½æ©™è‰²åœ†ç‚¹è°ƒæ•´ä½ç½® â†’ å®Œæˆé…ç½®</p>
                        </div>
                    </div>
                </div>
                
                <div class="toolbar">
                    <div class="toolbar-row">
                        <label>å½“å‰å›¾ç‰‡:</label>
                        <input type="url" id="imageUrl" name="imageUrl" placeholder="å›¾ç‰‡é“¾æ¥ï¼ˆç©ºç™½=ç« èŠ‚é¡µï¼‰" readonly style="background: #f8f9fa; flex: 1;">
                        <button class="btn-warning" id="clearMarkersBtn">æ¸…é™¤æ ‡è®°</button>
                    </div>
                    <div class="toolbar-row">
                        <label>å…¨å±€æ ‡é¢˜:</label>
                        <input type="text" id="globalTitle" name="globalTitle" value="äº²è‡ªè¯•ä¸€è¯•ï¼Œ3 æ­¥åˆ›å»ºä¸€ä¸ª CRM" style="flex: 1;">
                    </div>
                </div>
            </div>

            <!-- å³ä¾§é¢æ¿ - é¢„è§ˆå’ŒJSON -->
            <div class="right-panel">
                <div class="preview-section">
                    <div class="preview-header">
                        <h3>ğŸ” å®æ—¶é¢„è§ˆ</h3>
                        <div class="preview-controls">
                            <div class="step-counter" id="stepCounter">0 / 0</div>
                            <button class="btn-secondary" id="fullscreenBtn" title="å…¨å±é¢„è§ˆ">â›¶</button>
                        </div>
                    </div>
                    <div class="preview-content">
                        <div class="preview-demo" id="previewDemo">
                            <div style="text-align: center; padding: 40px; color: #666;">
                                <p>æš‚æ— é¢„è§ˆå†…å®¹</p>
                                <small>æ·»åŠ æ­¥éª¤åä¼šæ˜¾ç¤ºé¢„è§ˆ</small>
                            </div>
                        </div>
                    </div>
                    <div class="step-navigation">
                        <div class="nav-buttons">
                            <button class="btn-secondary" id="prevStepBtn" disabled>ä¸Šä¸€æ­¥</button>
                            <button class="btn-primary" id="nextStepBtn" disabled>ä¸‹ä¸€æ­¥</button>
                        </div>
                    </div>
                </div>
                
                <div class="json-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 8px 0 8px;">
                        <h4 style="margin: 0; font-size: 12px;">ğŸ“‹ JSONé…ç½® - å®æ—¶ç¼–è¾‘</h4>
                        <div style="display: flex; gap: 4px;">
                            <button class="btn-secondary" id="historyBtn" style="padding: 4px 10px; font-size: 11px;">ğŸ“œ å†å²</button>
                            <button class="btn-primary" id="exportComponentBtn" style="padding: 4px 10px; font-size: 11px;">å¯¼å‡ºä¸ºç»„ä»¶</button>
                        </div>
                    </div>
                    <textarea id="jsonEditor" style="width: calc(100% - 16px); flex: 1; min-height: 150px; margin: 8px 8px 8px 8px; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace; font-size: 11px; padding: 8px; border: 1px solid #007bff; border-radius: 4px; resize: vertical; background: #f8f9ff; transition: border-color 0.2s; line-height: 1.4;" placeholder="JSONé…ç½®å°†åœ¨è¿™é‡Œå®æ—¶æ˜¾ç¤ºå’Œç¼–è¾‘..."></textarea>
                    <div id="jsonStatus" style="margin: 4px 8px 8px 8px; font-size: 10px; color: #666;">å‡†å¤‡å°±ç»ª</div>
                </div>
            </div>
        </div>
    </div>

    <!-- å…¨å±é¢„è§ˆè¦†ç›–å±‚ -->
    <div class="fullscreen-overlay" id="fullscreenOverlay">
        <div class="fullscreen-content">
            <div class="fullscreen-header">
                <h2 id="fullscreenTitle">Demo é¢„è§ˆ</h2>
                <button class="close-fullscreen" id="closeFullscreenBtn">âœ• é€€å‡ºå…¨å±</button>
            </div>
            <div class="fullscreen-demo" id="fullscreenDemo">
                <!-- å…¨å±é¢„è§ˆå†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="fullscreen-navigation">
                <div class="step-counter" id="fullscreenStepCounter">0 / 0</div>
                <div class="nav-buttons">
                    <button class="btn-secondary" id="fullscreenPrevBtn" disabled>ä¸Šä¸€æ­¥</button>
                    <button class="btn-primary" id="fullscreenNextBtn" disabled>ä¸‹ä¸€æ­¥</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å†å²è®°å½•å¼¹çª— -->
    <div id="historyModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; max-width: 800px; width: 90%; max-height: 80vh; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">ğŸ“œ ä¿å­˜å†å²ï¼ˆæœ€è¿‘100æ¡ï¼‰</h3>
                <button onclick="document.getElementById('historyModal').style.display='none'" style="background: none; border: none; font-size: 24px; cursor: pointer;">Ã—</button>
            </div>
            <div id="historyList" style="flex: 1; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px;">
                <!-- å†å²è®°å½•åˆ—è¡¨ -->
            </div>
            <div style="margin-top: 10px; text-align: right;">
                <button onclick="demoEditor.clearHistory()" class="btn-warning" style="float: left;">æ¸…ç©ºå†å²</button>
                <button onclick="document.getElementById('historyModal').style.display='none'" class="btn-secondary">å…³é—­</button>
            </div>
        </div>
    </div>

    <script>
        class DemoConfigEditor {
            constructor() {
                this.config = {
                    title: "äº²è‡ªè¯•ä¸€è¯•ï¼Œ3 æ­¥åˆ›å»ºä¸€ä¸ª CRM",
                    subtitle: "",
                    steps: []  // mainSteps å°†ä»ç« èŠ‚é¡µè‡ªåŠ¨ç”Ÿæˆ
                };
                this.currentStepIndex = -1;
                this.currentImage = null;
                this.previewCurrentStep = 0;
                this.isDragging = false;
                this.dragStepIndex = -1;
                this.dragStartPos = { x: 0, y: 0 };
                this.imageUpdateTimer = null;
                this.stepFieldUpdateTimer = null;
                this.resizeTimer = null;
                this.isUpdatingStepsList = false;
                this.isUpdatingFromJson = false;
                this.draggedStepIndex = null;
                
                // è‡ªåŠ¨ä¿å­˜ç›¸å…³
                this.lastSavedConfig = '';
                this.saveHistory = [];
                this.autoSaveTimer = null;
                
                this.init();
            }

            init() {
                this.bindEvents();
                this.setupJsonEditor();
                // ä¸å†åŠ è½½é¢„ç½®ç¤ºä¾‹ï¼Œä»ç©ºé…ç½®å¼€å§‹
                this.loadSaveHistory();
                this.startAutoSave();
                this.updateCompactStepsList();
                this.updatePreview();
                this.updateJsonDisplay();
            }

            // loadPresetExample æ–¹æ³•å·²ç§»é™¤ï¼Œç°åœ¨ä»ç©ºé…ç½®å¼€å§‹

            bindEvents() {
                // å›¾ç‰‡ç‚¹å‡»äº‹ä»¶
                document.getElementById('imageDisplay').addEventListener('click', (e) => {
                    if (this.currentImage && this.currentStepIndex >= 0) {
                        this.addMarker(e);
                    }
                });

                // æŒ‰é’®äº‹ä»¶
                document.getElementById('clearMarkersBtn').addEventListener('click', () => this.clearMarkers());
                document.getElementById('prevStepBtn').addEventListener('click', () => this.previewPrevStep());
                document.getElementById('nextStepBtn').addEventListener('click', () => this.previewNextStep());
                document.getElementById('exportComponentBtn').addEventListener('click', () => this.exportAsComponent());
                document.getElementById('historyBtn').addEventListener('click', () => this.showHistory());
                
                // å…¨å±é¢„è§ˆäº‹ä»¶
                document.getElementById('fullscreenBtn').addEventListener('click', () => this.openFullscreenPreview());
                document.getElementById('closeFullscreenBtn').addEventListener('click', () => this.closeFullscreenPreview());
                document.getElementById('fullscreenPrevBtn').addEventListener('click', () => this.fullscreenPrevStep());
                document.getElementById('fullscreenNextBtn').addEventListener('click', () => this.fullscreenNextStep());
                
                // ESCé”®é€€å‡ºå…¨å±
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.closeFullscreenPreview();
                    }
                });
                
                // ç‚¹å‡»è¦†ç›–å±‚èƒŒæ™¯é€€å‡ºå…¨å±
                document.getElementById('fullscreenOverlay').addEventListener('click', (e) => {
                    if (e.target === document.getElementById('fullscreenOverlay')) {
                        this.closeFullscreenPreview();
                    }
                });

                // å…¨å±€é…ç½®å˜åŒ–
                document.getElementById('globalTitle').addEventListener('input', (e) => {
                    this.config.title = e.target.value;
                    this.updateJsonDisplay();
                });

                // å…¨å±€ç²˜è´´äº‹ä»¶ - è‡ªåŠ¨å¤„ç†å›¾ç‰‡URL
                document.addEventListener('paste', (e) => {
                    // åªæœ‰åœ¨æ²¡æœ‰èšç„¦åˆ°è¾“å…¥æ¡†æ—¶æ‰å¤„ç†
                    if (document.activeElement.tagName === 'INPUT' || 
                        document.activeElement.tagName === 'TEXTAREA') {
                        return;
                    }
                    
                    const clipboardData = e.clipboardData || window.clipboardData;
                    const pastedText = clipboardData.getData('text').trim();
                    
                    if (pastedText) {
                        e.preventDefault();
                        this.handleImagePaste(pastedText);
                    }
                });

                // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°è®¡ç®—åœ†ç‚¹ä½ç½®
                window.addEventListener('resize', () => {
                    if (this.resizeTimer) {
                        clearTimeout(this.resizeTimer);
                    }
                    this.resizeTimer = setTimeout(() => {
                        if (this.currentImage) {
                            this.renderMarkers();
                        }
                    }, 150); // é˜²æŠ–ï¼Œé¿å…é¢‘ç¹è®¡ç®—
                });
            }

            // åˆ¤æ–­æ­¥éª¤æ˜¯å¦ä¸ºç« èŠ‚é¡µï¼ˆæ²¡æœ‰imageå±æ€§çš„æ­¥éª¤ï¼‰
            isChapterStep(step) {
                // åªæœ‰å½“æ²¡æœ‰imageå±æ€§æ—¶æ‰æ˜¯ç« èŠ‚é¡µ
                // å¦‚æœæœ‰imageå±æ€§ä½†å€¼æ— æ•ˆï¼Œä»ç„¶æ˜¯æ™®é€šæ­¥éª¤
                return !('image' in step);
            }

            loadImage() {
                const url = document.getElementById('imageUrl').value.trim();
                if (!url) {
                    // æ˜¾ç¤ºç« èŠ‚é¡µ
                    this.displayChapterPage();
                    return;
                }

                const img = new Image();
                img.onload = () => {
                    this.currentImage = img;
                    this.displayImage(img, url);
                    this.ensureStepForImage(url);
                    // å›¾ç‰‡åŠ è½½å®Œæˆåå»¶æ—¶é‡æ–°æ¸²æŸ“åœ†ç‚¹ï¼Œç¡®ä¿å¸ƒå±€å®Œæˆ
                    setTimeout(() => {
                        this.renderMarkers();
                    }, 100);
                };
                img.onerror = () => {
                    // å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºç« èŠ‚é¡µ
                    this.displayChapterPage();
                };
                img.src = url;
            }

            displayChapterPage() {
                const container = document.getElementById('imageDisplay');
                this.currentImage = null;
                
                if (this.currentStepIndex >= 0) {
                    const step = this.config.steps[this.currentStepIndex];
                    container.innerHTML = `
                        <div class="chapter-display" id="chapterDisplay">
                            <div class="chapter-content">
                                <div class="chapter-number">${step.id}</div>
                                <br>
                                <div class="chapter-title">${step.title}</div>
                            </div>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="chapter-display" id="chapterDisplay">
                            <div class="chapter-content">
                                <div class="chapter-number">01</div>
                                <br>
                                <div class="chapter-title">ç« èŠ‚é¡µ</div>
                            </div>
                        </div>
                    `;
                }

                // æ·»åŠ ç« èŠ‚é¡µç‚¹å‡»äº‹ä»¶
                const chapterDisplay = document.getElementById('chapterDisplay');
                if (chapterDisplay) {
                    chapterDisplay.addEventListener('click', () => {
                        this.goToNextStep();
                    });
                }
            }

            ensureStepForImage(imageUrl) {
                // ç§»é™¤è‡ªåŠ¨è·³è½¬åˆ°ç›¸åŒå›¾ç‰‡æ­¥éª¤çš„é€»è¾‘
                // ç°åœ¨å…è®¸å¤šä¸ªæ­¥éª¤ä½¿ç”¨ç›¸åŒçš„å›¾ç‰‡
                if (this.config.steps.length === 0) {
                    this.autoCreateStepForCurrentImage();
                }
            }

            displayImage(img, url) {
                const container = document.getElementById('imageDisplay');
                container.innerHTML = '';
                
                img.style.maxWidth = '100%';
                img.style.maxHeight = '100%';
                img.style.borderRadius = '4px';
                img.style.cursor = 'crosshair';
                img.className = 'demo-image';
                
                // ç›‘å¬å›¾ç‰‡åœ¨DOMä¸­çš„åŠ è½½å®Œæˆäº‹ä»¶
                img.addEventListener('load', () => {
                    // å»¶æ—¶é‡æ–°æ¸²æŸ“åœ†ç‚¹ï¼Œç¡®ä¿å›¾ç‰‡å°ºå¯¸è®¡ç®—æ­£ç¡®
                    setTimeout(() => {
                        this.renderMarkers();
                    }, 50);
                });
                
                container.appendChild(img);

                // å¦‚æœå½“å‰æ­¥éª¤å­˜åœ¨ï¼Œæ›´æ–°å…¶å›¾ç‰‡URL
                if (this.currentStepIndex >= 0) {
                    this.config.steps[this.currentStepIndex].image = url;
                    this.updateCompactStepsList();
                }

                // ç«‹å³æ¸²æŸ“æ ‡è®°ï¼ˆå¯èƒ½ä½ç½®æš‚æ—¶ä¸å‡†ç¡®ï¼‰
                this.renderMarkers();
                
                // å»¶æ—¶å†æ¬¡æ¸²æŸ“ï¼Œç¡®ä¿å¸ƒå±€å®Œæˆ
                setTimeout(() => {
                    this.renderMarkers();
                }, 100);
            }

            addMarker(e) {
                if (!this.currentImage) return;

                if (this.currentStepIndex < 0 || this.config.steps.length === 0) {
                    this.autoCreateStepForCurrentImage();
                }

                const position = this.calculatePositionFromEvent(e);
                
                const step = this.config.steps[this.currentStepIndex];
                if (!step.button) {
                    step.button = {
                        id: 'button' + (this.currentStepIndex + 1),
                        label: step.title || "ç‚¹å‡»ç»§ç»­",
                        position: {},
                        balloonPos: "up",
                        balloonLength: "medium"
                    };
                }

                step.button.position = position;

                this.updateCompactStepsList();
                this.renderMarkers();
                this.updatePreview();
            }

            autoCreateStepForCurrentImage() {
                const imageUrl = document.getElementById('imageUrl').value.trim();
                
                const newStep = {
                    id: 'step-' + this.config.steps.length,
                    title: 'æ­¥éª¤ ' + (this.config.steps.length + 1),
                    description: "æ­¥éª¤æè¿°"
                };

                // åªæœ‰æœ‰å›¾ç‰‡URLæ—¶æ‰æ·»åŠ imageå±æ€§
                if (imageUrl) {
                    newStep.image = imageUrl;
                }

                this.config.steps.push(newStep);
                this.selectCompactStep(this.config.steps.length - 1);
                this.updateCompactStepsList();
            }

            calculatePositionFromEvent(e) {
                const container = document.getElementById('imageDisplay');
                const containerRect = container.getBoundingClientRect();
                const img = this.currentImage;
                const imgRect = img.getBoundingClientRect();

                // è®¡ç®—ç›¸å¯¹äºå›¾ç‰‡çš„ç²¾ç¡®ä½ç½®
                const x = ((e.clientX - imgRect.left) / imgRect.width) * 100;
                const y = ((e.clientY - imgRect.top) / imgRect.height) * 100;

                // ç¡®ä¿ä½ç½®åœ¨å›¾ç‰‡èŒƒå›´å†…
                const clampedX = Math.max(0, Math.min(100, x));
                const clampedY = Math.max(0, Math.min(100, y));

                // æ ¹æ®ä½ç½®å†³å®šä½¿ç”¨leftè¿˜æ˜¯right
                if (clampedX <= 50) {
                    return {
                        left: clampedX.toFixed(1) + '%',
                        top: clampedY.toFixed(1) + '%'
                    };
                } else {
                    return {
                        right: (100 - clampedX).toFixed(1) + '%',
                        top: clampedY.toFixed(1) + '%'
                    };
                }
            }

            renderMarkers() {
                if (!this.currentImage) return;

                // ç§»é™¤ç°æœ‰æ ‡è®°
                const existingMarkers = document.querySelectorAll('.marker');
                existingMarkers.forEach(marker => marker.remove());

                const container = document.getElementById('imageDisplay');
                if (!container) return;

                // åªæ˜¾ç¤ºå½“å‰æ­¥éª¤çš„æ ‡è®°
                if (this.currentStepIndex >= 0 && this.currentStepIndex < this.config.steps.length) {
                    const step = this.config.steps[this.currentStepIndex];
                    if (step.button && step.button.position) {
                        try {
                            const marker = this.createMarker(step.button.position, this.currentStepIndex);
                            if (marker) {
                                container.appendChild(marker);
                            }
                        } catch (error) {
                            console.warn('Failed to create marker:', error);
                            // å»¶æ—¶é‡è¯•
                            setTimeout(() => {
                                this.renderMarkers();
                            }, 200);
                        }
                    }
                }
            }

            createMarker(position, stepIndex) {
                const marker = document.createElement('div');
                marker.className = 'marker';
                marker.style.position = 'absolute';
                marker.style.cursor = 'grab';
                marker.dataset.stepIndex = stepIndex;
                
                // è·å–å›¾ç‰‡çš„å®é™…è¾¹ç•Œ
                const img = this.currentImage;
                const container = document.getElementById('imageDisplay');
                const imgRect = img.getBoundingClientRect();
                const containerRect = container.getBoundingClientRect();
                
                // æ£€æŸ¥å›¾ç‰‡æ˜¯å¦å·²ç»æ­£ç¡®æ¸²æŸ“
                if (imgRect.width === 0 || imgRect.height === 0) {
                    // å›¾ç‰‡è¿˜æœªå®Œå…¨æ¸²æŸ“ï¼Œè¿”å›nullä»¥ä¾¿é‡è¯•
                    return null;
                }
                
                // è®¡ç®—å›¾ç‰‡ç›¸å¯¹äºå®¹å™¨çš„ä½ç½®å’Œå°ºå¯¸
                const imgLeft = imgRect.left - containerRect.left;
                const imgTop = imgRect.top - containerRect.top;
                const imgWidth = imgRect.width;
                const imgHeight = imgRect.height;
                
                // å°†ç™¾åˆ†æ¯”ä½ç½®è½¬æ¢ä¸ºåƒç´ ä½ç½®
                let markerLeft, markerTop;
                if (position.left) {
                    const leftPercent = parseFloat(position.left);
                    markerLeft = imgLeft + (imgWidth * leftPercent / 100) - 40; // å‡å»åœ†åœˆåŠå¾„
                } else if (position.right) {
                    const rightPercent = parseFloat(position.right);
                    markerLeft = imgLeft + imgWidth - (imgWidth * rightPercent / 100) - 40;
                }
                
                const topPercent = parseFloat(position.top);
                markerTop = imgTop + (imgHeight * topPercent / 100) - 40; // å‡å»åœ†åœˆåŠå¾„
                
                marker.style.left = markerLeft + 'px';
                marker.style.top = markerTop + 'px';

                // å¦‚æœæ˜¯å½“å‰æ­¥éª¤ï¼Œä½¿ç”¨ä¸åŒé¢œè‰²
                const color = stepIndex === this.currentStepIndex ? '#2196f3' : '#fa541c';

                const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.setAttribute('width', '80');
                svg.setAttribute('height', '80');
                svg.setAttribute('viewBox', '0 0 45 45');
                svg.setAttribute('stroke', color);

                svg.innerHTML = '<g fill="none" fill-rule="evenodd" transform="translate(1 1)" stroke-width="2">' +
                    '<circle cx="22" cy="22" r="6" stroke-opacity="0">' +
                    '<animate attributeName="r" begin="1.5s" dur="3s" values="6;22" calcMode="linear" repeatCount="indefinite"/>' +
                    '<animate attributeName="stroke-opacity" begin="1.5s" dur="3s" values="1;0" calcMode="linear" repeatCount="indefinite"/>' +
                    '<animate attributeName="stroke-width" begin="1.5s" dur="3s" values="2;0" calcMode="linear" repeatCount="indefinite"/>' +
                    '</circle>' +
                    '<circle cx="22" cy="22" r="8">' +
                    '<animate attributeName="r" begin="0s" dur="1.5s" values="6;1;2;3;4;5;6" calcMode="linear" repeatCount="indefinite"/>' +
                    '</circle>' +
                    '<circle cx="22" cy="22" r="3" fill="' + color + '" stroke="none"/>' +
                    '</g>';

                marker.appendChild(svg);

                // æ·»åŠ æŒ‰é’®æ–‡æœ¬æ ‡ç­¾ï¼ˆå¸¦ç®­å¤´ï¼‰
                const step = this.config.steps[stepIndex];
                if (step.button && step.button.label) {
                    const label = document.createElement('div');
                    label.className = 'marker-label';
                    label.textContent = step.button.label;
                    label.style.position = 'absolute';
                    label.style.background = 'rgba(250, 84, 28, 0.9)';
                    label.style.color = 'white';
                    label.style.padding = '8px 12px';
                    label.style.borderRadius = '4px';
                    label.style.fontSize = '12px';
                    label.style.whiteSpace = 'nowrap';
                    label.style.pointerEvents = 'none';
                    label.style.zIndex = '1';
                    label.style.maxWidth = '180px';

                    // æ ¹æ®balloonPosè®¾ç½®ä½ç½®
                    const balloonPos = step.button.balloonPos || 'up';
                    switch (balloonPos) {
                        case 'up':
                            label.style.left = '50%';
                            label.style.bottom = '100%';
                            label.style.transform = 'translateX(-50%)';
                            label.style.marginBottom = '8px';
                            break;
                        case 'down':
                            label.style.left = '50%';
                            label.style.top = '100%';
                            label.style.transform = 'translateX(-50%)';
                            label.style.marginTop = '8px';
                            break;
                        case 'left':
                            label.style.right = '100%';
                            label.style.top = '50%';
                            label.style.transform = 'translateY(-50%)';
                            label.style.marginRight = '8px';
                            break;
                        case 'right':
                            label.style.left = '100%';
                            label.style.top = '50%';
                            label.style.transform = 'translateY(-50%)';
                            label.style.marginLeft = '8px';
                            break;
                        default:
                            label.style.left = '50%';
                            label.style.top = '100%';
                            label.style.transform = 'translateX(-50%)';
                            label.style.marginTop = '8px';
                    }

                    // æ·»åŠ ç®­å¤´æŒ‡ç¤ºå™¨
                    const arrow = document.createElement('div');
                    arrow.style.position = 'absolute';
                    arrow.style.width = '0';
                    arrow.style.height = '0';
                    arrow.style.zIndex = '2';
                    
                    switch (balloonPos) {
                        case 'up':
                            arrow.style.left = '50%';
                            arrow.style.top = '100%';
                            arrow.style.transform = 'translateX(-50%)';
                            arrow.style.borderLeft = '8px solid transparent';
                            arrow.style.borderRight = '8px solid transparent';
                            arrow.style.borderTop = '8px solid rgba(250, 84, 28, 0.9)';
                            arrow.style.marginTop = '-2px';
                            break;
                        case 'down':
                            arrow.style.left = '50%';
                            arrow.style.bottom = '100%';
                            arrow.style.transform = 'translateX(-50%)';
                            arrow.style.borderLeft = '8px solid transparent';
                            arrow.style.borderRight = '8px solid transparent';
                            arrow.style.borderBottom = '8px solid rgba(250, 84, 28, 0.9)';
                            arrow.style.marginBottom = '-2px';
                            break;
                        case 'left':
                            arrow.style.top = '50%';
                            arrow.style.left = '100%';
                            arrow.style.transform = 'translateY(-50%)';
                            arrow.style.borderTop = '8px solid transparent';
                            arrow.style.borderBottom = '8px solid transparent';
                            arrow.style.borderLeft = '8px solid rgba(250, 84, 28, 0.9)';
                            arrow.style.marginLeft = '-2px';
                            break;
                        case 'right':
                            arrow.style.top = '50%';
                            arrow.style.right = '100%';
                            arrow.style.transform = 'translateY(-50%)';
                            arrow.style.borderTop = '8px solid transparent';
                            arrow.style.borderBottom = '8px solid transparent';
                            arrow.style.borderRight = '8px solid rgba(250, 84, 28, 0.9)';
                            arrow.style.marginRight = '-2px';
                            break;
                    }
                    
                    label.appendChild(arrow);
                    marker.appendChild(label);
                }

                // æ‹–æ‹½äº‹ä»¶
                marker.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                    if (e.shiftKey) {
                        // Shift+ç‚¹å‡»åˆ é™¤æŒ‰é’®é…ç½®
                        this.config.steps[stepIndex].button = undefined;
                        this.renderMarkers();
                        if (stepIndex === this.currentStepIndex) {
                            this.updateCompactStepsList();
                        }
                        this.updatePreview();
                        return;
                    }
                    
                    this.startDrag(e, stepIndex);
                });

                // æ™®é€šç‚¹å‡»é€‰æ‹©æ­¥éª¤ï¼ˆåªåœ¨æ²¡æœ‰æ‹–æ‹½æ—¶è§¦å‘ï¼‰
                marker.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (!this.isDragging) {
                        this.selectCompactStep(stepIndex);
                    }
                });

                return marker;
            }

            startDrag(e, stepIndex) {
                this.isDragging = true;
                this.dragStepIndex = stepIndex;
                this.dragStartPos = { x: e.clientX, y: e.clientY };

                const marker = e.currentTarget;
                marker.style.cursor = 'grabbing';
                marker.style.zIndex = '1000';

                // å…¨å±€é¼ æ ‡äº‹ä»¶
                const onMouseMove = (e) => this.onDrag(e);
                const onMouseUp = (e) => {
                    this.endDrag(e);
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                    marker.style.cursor = 'grab';
                    marker.style.zIndex = '10';
                };

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);

                // é€‰æ‹©è¢«æ‹–æ‹½çš„æ­¥éª¤
                this.selectCompactStep(stepIndex);
            }

            onDrag(e) {
                if (!this.isDragging || this.dragStepIndex < 0) return;

                // è®¡ç®—æ–°ä½ç½®
                const position = this.calculatePositionFromEvent(e);
                
                // æ›´æ–°æ­¥éª¤é…ç½®
                const step = this.config.steps[this.dragStepIndex];
                if (step.button) {
                    step.button.position = position;
                }

                // å®æ—¶æ›´æ–°æ˜¾ç¤º
                this.renderMarkers();
                this.updateCompactStepsList();
                this.updatePreview();
            }

            endDrag(e) {
                if (!this.isDragging) return;

                const deltaX = Math.abs(e.clientX - this.dragStartPos.x);
                const deltaY = Math.abs(e.clientY - this.dragStartPos.y);
                
                // å¦‚æœç§»åŠ¨è·ç¦»å¾ˆå°ï¼Œè§†ä¸ºç‚¹å‡»
                if (deltaX < 5 && deltaY < 5) {
                    // è¿™æ˜¯ä¸€ä¸ªç‚¹å‡»ï¼Œä¸æ˜¯æ‹–æ‹½
                    this.selectCompactStep(this.dragStepIndex);
                }

                this.isDragging = false;
                this.dragStepIndex = -1;
            }

            handleImagePaste(imageUrl) {
                // æ£€æŸ¥å½“å‰æ˜¯å¦åœ¨"å¾…æ·»åŠ "è¾“å…¥æ¡†ä¸­
                const pendingInput = document.querySelector('.step-item.pending input');
                if (pendingInput && pendingInput === document.activeElement) {
                    // å¦‚æœåœ¨å¾…æ·»åŠ è¾“å…¥æ¡†ä¸­ï¼Œå¡«å……å€¼ä½†ä¸åˆ›å»ºæ­¥éª¤ï¼ˆè®©è¾“å…¥æ¡†çš„äº‹ä»¶å¤„ç†ï¼‰
                    pendingInput.value = imageUrl;
                    return;
                }
                
                // å¦åˆ™åˆ›å»ºæ–°æ­¥éª¤
                const newStep = {
                    id: 'step-' + this.config.steps.length,
                    title: 'æ­¥éª¤ ' + (this.config.steps.length + 1),
                    description: "æ­¥éª¤æè¿°",
                    image: imageUrl
                };

                this.config.steps.push(newStep);
                const newStepIndex = this.config.steps.length - 1;
                
                document.getElementById('imageUrl').value = imageUrl;
                
                const img = new Image();
                img.onload = () => {
                    this.currentImage = img;
                    this.displayImage(img, imageUrl);
                    this.selectCompactStep(newStepIndex);
                };
                img.onerror = () => {
                    this.config.steps.pop();
                    this.updateCompactStepsList();
                };
                img.src = imageUrl;
                
                this.updateCompactStepsList();
                this.updatePreview();
            }

            // === ç´§å‡‘æ­¥éª¤åˆ—è¡¨ç®¡ç† ===

            updateCompactStepsList() {
                // é˜²æ­¢é‡å…¥è°ƒç”¨
                if (this.isUpdatingStepsList) {
                    return;
                }
                this.isUpdatingStepsList = true;

                try {
                    const container = document.getElementById('compactStepsList');
                    if (!container) return;
                    
                    // ä¿å­˜å½“å‰èšç„¦çš„å…ƒç´ 
                    const activeElement = document.activeElement;
                    const activeElementId = activeElement?.id;
                    const activeElementValue = activeElement?.value;
                    const activeElementSelectionStart = activeElement?.selectionStart;
                    const activeElementSelectionEnd = activeElement?.selectionEnd;
                    
                    container.innerHTML = '';

                    // æ¸²æŸ“ç°æœ‰æ­¥éª¤
                    this.config.steps.forEach((step, index) => {
                        const stepElement = this.createCompactStepElement(step, index);
                        container.appendChild(stepElement);
                    });

                    // æ·»åŠ "å¾…æ·»åŠ "æ­¥éª¤
                    const pendingStepElement = this.createPendingStepElement();
                    container.appendChild(pendingStepElement);
                    
                    // æ¢å¤èšç„¦
                    if (activeElementId) {
                        const newActiveElement = document.getElementById(activeElementId);
                        if (newActiveElement && newActiveElement.tagName === 'INPUT') {
                            newActiveElement.value = activeElementValue || '';
                            newActiveElement.focus();
                            if (activeElementSelectionStart !== undefined && activeElementSelectionEnd !== undefined) {
                                newActiveElement.setSelectionRange(activeElementSelectionStart, activeElementSelectionEnd);
                            }
                        }
                    }
                } finally {
                    this.isUpdatingStepsList = false;
                }
            }

            createCompactStepElement(step, index) {
                const div = document.createElement('div');
                const isChapter = this.isChapterStep(step);
                div.className = `step-item ${index === this.currentStepIndex ? 'active' : ''} ${isChapter ? 'chapter' : ''}`;
                div.dataset.stepIndex = index;
                div.draggable = true;
                
                // æ·»åŠ æ‹–æ‹½äº‹ä»¶
                div.addEventListener('dragstart', (e) => this.onStepDragStart(e, index));
                div.addEventListener('dragover', (e) => this.onStepDragOver(e, index));
                div.addEventListener('drop', (e) => this.onStepDrop(e, index));
                div.addEventListener('dragend', (e) => this.onStepDragEnd(e));
                div.addEventListener('dragenter', (e) => this.onStepDragEnter(e));
                div.addEventListener('dragleave', (e) => this.onStepDragLeave(e));
                
                div.addEventListener('click', (e) => {
                    // é¿å…æ‹–æ‹½æ‰‹æŸ„è§¦å‘é€‰æ‹©
                    if (!e.target.classList.contains('drag-handle')) {
                        this.selectCompactStep(index);
                    }
                });

                // ç« èŠ‚é¡µæ ‡è¯†
                const chapterIndicator = isChapter ? 'ğŸ“' : '';
                
                // ç« èŠ‚é¡µæ˜¾ç¤ºå®é™…æ ‡é¢˜ï¼Œæ™®é€šæ­¥éª¤è‡ªåŠ¨ç”Ÿæˆ
                const displayTitle = isChapter ? (step.title || `ç« èŠ‚ ${index + 1}`) : `æ­¥éª¤ ${index + 1}`;
                
                // ç« èŠ‚é¡µéœ€è¦æ ‡é¢˜è¾“å…¥æ¡†ï¼Œæ™®é€šé¡µéœ€è¦æŒ‰é’®æ ‡ç­¾è¾“å…¥æ¡†å’Œä½ç½®é€‰æ‹©
                const titleOrLabelInput = isChapter ? `
                    <input type="text" id="step-title-${index}" value="${step.title || ''}" placeholder="ç« èŠ‚æ ‡é¢˜" 
                           oninput="demoEditor.updateStepField(${index}, 'title', this.value)">
                ` : `
                    <input type="text" id="step-label-${index}" value="${step.button?.label || ''}" placeholder="æŒ‰é’®æ–‡å­—ï¼ˆç‚¹å‡»ç»§ç»­ä¸‹ä¸€æ­¥ï¼‰" 
                           oninput="demoEditor.updateButtonLabel(${index}, this.value)">
                    <div style="display: flex; gap: 2px; margin-top: 4px;">
                        <button type="button" onclick="demoEditor.updateButtonField(${index}, 'balloonPos', 'up')" 
                                style="flex: 1; padding: 4px 2px; font-size: 10px; border: 1px solid ${step.button?.balloonPos === 'up' ? '#007bff' : '#ccc'}; 
                                       background: ${step.button?.balloonPos === 'up' ? '#e3f2fd' : '#f8f9fa'}; cursor: pointer; border-radius: 2px;">ä¸Š</button>
                        <button type="button" onclick="demoEditor.updateButtonField(${index}, 'balloonPos', 'down')" 
                                style="flex: 1; padding: 4px 2px; font-size: 10px; border: 1px solid ${step.button?.balloonPos === 'down' ? '#007bff' : '#ccc'}; 
                                       background: ${step.button?.balloonPos === 'down' ? '#e3f2fd' : '#f8f9fa'}; cursor: pointer; border-radius: 2px;">ä¸‹</button>
                        <button type="button" onclick="demoEditor.updateButtonField(${index}, 'balloonPos', 'left')" 
                                style="flex: 1; padding: 4px 2px; font-size: 10px; border: 1px solid ${step.button?.balloonPos === 'left' ? '#007bff' : '#ccc'}; 
                                       background: ${step.button?.balloonPos === 'left' ? '#e3f2fd' : '#f8f9fa'}; cursor: pointer; border-radius: 2px;">å·¦</button>
                        <button type="button" onclick="demoEditor.updateButtonField(${index}, 'balloonPos', 'right')" 
                                style="flex: 1; padding: 4px 2px; font-size: 10px; border: 1px solid ${step.button?.balloonPos === 'right' ? '#007bff' : '#ccc'}; 
                                       background: ${step.button?.balloonPos === 'right' ? '#e3f2fd' : '#f8f9fa'}; cursor: pointer; border-radius: 2px;">å³</button>
                    </div>
                `;
                
                div.innerHTML = `
                    <div class="step-item-header">
                        <span><span class="drag-handle">â˜°</span>${chapterIndicator}${displayTitle}</span>
                        <div>
                            <button onclick="demoEditor.deleteStep(${index})">Ã—</button>
                        </div>
                    </div>
                    <input type="url" id="step-image-${index}" value="${step.image || ''}" placeholder="å›¾ç‰‡é“¾æ¥ï¼ˆç©ºç™½æˆ–æ— æ•ˆ=ç« èŠ‚é¡µï¼‰" 
                           oninput="demoEditor.updateStepImageWithDebounce(${index}, this.value)">
                    ${titleOrLabelInput}
                `;

                return div;
            }

            createPendingStepElement() {
                const div = document.createElement('div');
                div.className = 'step-item pending';
                
                div.innerHTML = `
                    <div class="step-item-header">
                        <span>+ æ–°å»ºæ­¥éª¤</span>
                    </div>
                    <input type="url" placeholder="ç²˜è´´å›¾ç‰‡URLåæŒ‰å›è½¦ï¼Œæˆ–ç›´æ¥æŒ‰ç©ºæ ¼/å›è½¦åˆ›å»ºç« èŠ‚é¡µ" 
                           onpaste="event.stopPropagation()"
                           onkeypress="if(event.key === 'Enter') { event.preventDefault(); demoEditor.createStepFromPendingImage(this.value); this.value = ''; } else if(event.key === ' ') { event.preventDefault(); demoEditor.createStepFromPendingImage(''); this.value = ''; }">
                `;

                return div;
            }

            selectCompactStep(index) {
                if (index === this.currentStepIndex) {
                    return;
                }
                
                this.currentStepIndex = index;
                this.previewCurrentStep = index; // åŒæ­¥é¢„è§ˆæ­¥éª¤
                this.updateCompactStepsList();
                
                // å¦‚æœæ­¥éª¤æœ‰å›¾ç‰‡ï¼ŒåŠ è½½å®ƒï¼›å¦åˆ™æ˜¾ç¤ºç« èŠ‚é¡µ
                const step = this.config.steps[index];
                if (step && step.image && step.image.trim()) {
                    document.getElementById('imageUrl').value = step.image;
                    this.loadImage();
                } else {
                    document.getElementById('imageUrl').value = '';
                    this.displayChapterPage();
                }

                this.renderMarkers();
                this.updatePreview();
            }

            updateStepField(index, field, value) {
                if (index >= 0 && index < this.config.steps.length) {
                    const step = this.config.steps[index];
                    
                    if (value && value.trim()) {
                        step[field] = value.trim();
                        
                        // å¦‚æœæ˜¯ç« èŠ‚é¡µçš„titleæ›´æ–°ï¼ŒåŒæ­¥æ›´æ–°å…¶ä»–ç›¸å…³å­—æ®µ
                        if (field === 'title' && this.isChapterStep(step)) {
                            // åŒæ­¥æ›´æ–°description
                            step.description = value.trim();
                            // å¦‚æœæœ‰buttoné…ç½®ï¼ŒåŒæ­¥æ›´æ–°label
                            if (step.button) {
                                step.button.label = value.trim();
                            }
                        }
                    } else {
                        // å¦‚æœå€¼ä¸ºç©ºï¼Œåˆ é™¤è¯¥å­—æ®µ
                        delete step[field];
                    }
                    
                    // ä½¿ç”¨é˜²æŠ–æŠ€æœ¯é¿å…é¢‘ç¹é‡æ–°æ¸²æŸ“
                    this.updateStepFieldWithDebounce();
                    this.updateJsonDisplay();
                }
            }

            updateStepFieldWithDebounce() {
                // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
                if (this.stepFieldUpdateTimer) {
                    clearTimeout(this.stepFieldUpdateTimer);
                }
                
                // è®¾ç½®æ–°çš„å®šæ—¶å™¨
                this.stepFieldUpdateTimer = setTimeout(() => {
                    this.updateCompactStepsList();
                    this.updatePreview();
                }, 300); // 300mså»¶è¿Ÿ
            }

            // æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆçš„å›¾ç‰‡URL
            isValidImageUrl(url) {
                if (!url || !url.trim()) return false;
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºURLæ ¼å¼
                try {
                    const urlObj = new URL(url);
                    // æ£€æŸ¥æ˜¯å¦ä¸ºhttp/httpsåè®®
                    if (!['http:', 'https:'].includes(urlObj.protocol)) {
                        return false;
                    }
                    // æ£€æŸ¥æ˜¯å¦æœ‰å¸¸è§çš„å›¾ç‰‡æ‰©å±•åæˆ–è€…æ˜¯å›¾ç‰‡æœåŠ¡çš„URL
                    const imageExtensions = /\.(jpg|jpeg|png|gif|webp|svg|bmp|ico)$/i;
                    const imageServices = /(nocobase|cloudinary|imgur|unsplash|picsum|placeholder)/i;
                    
                    return imageExtensions.test(urlObj.pathname) || imageServices.test(url);
                } catch {
                    // å¦‚æœä¸æ˜¯æœ‰æ•ˆçš„URLæ ¼å¼
                    return false;
                }
            }
            
            updateStepImage(index, imageUrl) {
                if (index >= 0 && index < this.config.steps.length) {
                    const step = this.config.steps[index];
                    const wasChapter = !('image' in step);  // åˆ¤æ–­æ˜¯å¦ä¸ºç« èŠ‚é¡µï¼ˆæ²¡æœ‰imageå±æ€§ï¼‰
                    const trimmedUrl = imageUrl ? imageUrl.trim() : '';
                    const isValidImage = this.isValidImageUrl(trimmedUrl);
                    
                    // å¦‚æœæ˜¯ç©ºçš„æˆ–æ— æ•ˆçš„URLï¼Œå˜æˆç« èŠ‚é¡µ
                    if (!isValidImage) {
                        // åˆ é™¤imageå±æ€§ï¼Œå˜æˆç« èŠ‚é¡µ
                        delete step.image;
                        
                        // å¦‚æœä»æ™®é€šæ­¥éª¤å˜ä¸ºç« èŠ‚é¡µï¼Œä¿æŒåŸæœ‰çš„æŒ‰é’®æ–‡å­—ä½œä¸ºæ ‡é¢˜
                        if (!wasChapter && step.button && step.button.label) {
                            step.title = step.button.label;
                            // åŒæ—¶æ›´æ–°descriptionä¿æŒä¸€è‡´
                            step.description = step.button.label;
                        }
                        
                        // ä¿ç•™å…¶ä»–å±æ€§ï¼Œç”¨äºå…¼å®¹å’Œå¯¼å‡º
                        
                    } else {
                        // æœ‰æ•ˆçš„å›¾ç‰‡URLï¼Œä¿ç•™ä¸ºæ™®é€šæ­¥éª¤
                        step.image = trimmedUrl;
                        
                        // å¦‚æœä»ç« èŠ‚é¡µå˜ä¸ºæ™®é€šæ­¥éª¤ï¼Œä¿æŒæ–‡å­—å†…å®¹
                        if (wasChapter) {
                            // å¦‚æœæœ‰titleï¼Œå°†å…¶å¤åˆ¶åˆ°button.labelå’Œdescription
                            if (step.title) {
                                if (!step.button) {
                                    step.button = {
                                        id: 'button' + (index + 1),
                                        label: step.title,
                                        position: { left: "50%", top: "50%" },
                                        balloonPos: "up",
                                        balloonLength: "medium"
                                    };
                                } else {
                                    step.button.label = step.title;
                                }
                                step.description = step.title;
                            }
                            // ç”Ÿæˆæ ‡å‡†çš„æ­¥éª¤title
                            step.title = `Step ${index + 1}`;
                        }
                    }
                    
                    // å¦‚æœæ˜¯å½“å‰é€‰ä¸­çš„æ­¥éª¤ï¼Œé‡æ–°åŠ è½½
                    if (index === this.currentStepIndex) {
                        document.getElementById('imageUrl').value = imageUrl || '';
                        if (isValidImage) {
                            this.loadImage();
                        } else {
                            this.displayChapterPage();
                        }
                    }
                    
                    this.updateCompactStepsList();
                    this.updatePreview();
                    this.updateJsonDisplay();
                }
            }

            // é˜²æŠ–ç‰ˆæœ¬çš„å›¾ç‰‡æ›´æ–°
            updateStepImageWithDebounce(index, imageUrl) {
                // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
                if (this.imageUpdateTimer) {
                    clearTimeout(this.imageUpdateTimer);
                }
                
                // è®¾ç½®æ–°çš„å®šæ—¶å™¨
                this.imageUpdateTimer = setTimeout(() => {
                    this.updateStepImage(index, imageUrl);
                }, 500); // 500mså»¶è¿Ÿ
            }

            updateButtonField(index, field, value) {
                if (index >= 0 && index < this.config.steps.length) {
                    const step = this.config.steps[index];
                    if (!step.button) {
                        step.button = {
                            id: 'button' + (index + 1),
                            label: "ç‚¹å‡»ç»§ç»­",
                            position: { left: "50%", top: "50%" },
                            balloonPos: "up",
                            balloonLength: "medium"
                        };
                    }
                    step.button[field] = value;
                    
                    // å¦‚æœæ”¹å˜çš„æ˜¯balloonPosï¼Œç«‹å³é‡æ–°æ¸²æŸ“æ ‡è®°å’Œåˆ—è¡¨
                    if (field === 'balloonPos') {
                        this.renderMarkers();
                        this.updateCompactStepsList();
                        this.updatePreview();
                    } else if (field === 'label') {
                        // labelå˜åŒ–ä½¿ç”¨é˜²æŠ–
                        this.renderMarkers();
                        this.updateStepFieldWithDebounce();
                    } else {
                        this.updateStepFieldWithDebounce();
                    }
                    
                    this.updateJsonDisplay();
                }
            }
            
            updateButtonLabel(index, value) {
                if (index >= 0 && index < this.config.steps.length) {
                    const step = this.config.steps[index];
                    
                    // å¦‚æœæ²¡æœ‰æŒ‰é’®é…ç½®ï¼Œåˆ›å»ºä¸€ä¸ªé»˜è®¤çš„
                    if (!step.button) {
                        step.button = {
                            id: 'button' + (index + 1),
                            label: value || "ç‚¹å‡»ç»§ç»­",
                            position: { left: "50%", top: "50%" },
                            balloonPos: "up",
                            balloonLength: "medium"
                        };
                    } else {
                        step.button.label = value || "ç‚¹å‡»ç»§ç»­";
                    }
                    
                    // åŒæ—¶æ›´æ–°descriptionï¼Œè®©å®ƒç­‰äºlabel
                    step.description = value || "ç‚¹å‡»ç»§ç»­";
                    
                    // æ›´æ–°æ ‡è®°å’ŒJSONæ˜¾ç¤º
                    this.renderMarkers();
                    this.updateJsonDisplay();
                }
            }

            createStepFromPendingImage(imageUrl) {
                const stepNumber = this.config.steps.length + 1;
                const trimmedUrl = imageUrl ? imageUrl.trim() : '';
                const isValidImage = this.isValidImageUrl(trimmedUrl);
                
                // æ ¹æ®URLæœ‰æ•ˆæ€§å†³å®šåˆ›å»ºç« èŠ‚è¿˜æ˜¯æ™®é€šæ­¥éª¤
                if (isValidImage) {
                    // åˆ›å»ºæ™®é€šæ­¥éª¤
                    const newStep = {
                        id: `step-${stepNumber}`,
                        title: `Step ${stepNumber}`,
                        description: "",
                        image: trimmedUrl
                    };
                    this.config.steps.push(newStep);
                } else {
                    // åˆ›å»ºç« èŠ‚é¡µï¼ˆä¿ç•™æ‰€æœ‰å­—æ®µç”¨äºå…¼å®¹ï¼‰
                    const newStep = {
                        id: `chapter-${stepNumber}`,
                        title: "",  // ç©ºæ ‡é¢˜ç­‰å¾…ç”¨æˆ·è¾“å…¥
                        description: ""  // ä¿ç•™descriptionå­—æ®µ
                    };
                    this.config.steps.push(newStep);
                }

                this.selectCompactStep(this.config.steps.length - 1);
                
                if (isValidImage) {
                    document.getElementById('imageUrl').value = trimmedUrl;
                    this.loadImage();
                } else {
                    document.getElementById('imageUrl').value = '';
                    this.displayChapterPage();
                }
            }

            deleteStep(index) {
                if (index >= 0 && index < this.config.steps.length) {
                    this.config.steps.splice(index, 1);
                    
                    if (this.currentStepIndex >= index) {
                        this.currentStepIndex = Math.max(0, this.currentStepIndex - 1);
                        if (this.config.steps.length === 0) {
                            this.currentStepIndex = -1;
                        }
                    }
                    
                    this.updateCompactStepsList();
                    this.updatePreview();
                }
            }

            // JSONå®æ—¶ç¼–è¾‘åŠŸèƒ½
            setupJsonEditor() {
                const jsonEditor = document.getElementById('jsonEditor');
                
                // é˜²æŠ–å®šæ—¶å™¨
                let jsonUpdateTimer = null;
                
                jsonEditor.addEventListener('input', (e) => {
                    // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
                    if (jsonUpdateTimer) {
                        clearTimeout(jsonUpdateTimer);
                    }
                    
                    // è®¾ç½®æ–°çš„å®šæ—¶å™¨ï¼Œ300msååº”ç”¨æ›´æ”¹
                    jsonUpdateTimer = setTimeout(() => {
                        this.applyJsonFromEditor();
                    }, 300);
                    
                    // ç«‹å³æ˜¾ç¤ºçŠ¶æ€
                    this.updateJsonStatus('æ­£åœ¨è¾“å…¥...');
                });

                jsonEditor.addEventListener('focus', () => {
                    this.updateJsonStatus('å¯ç›´æ¥ç¼–è¾‘JSONé…ç½®');
                });

                jsonEditor.addEventListener('blur', () => {
                    this.updateJsonStatus('å‡†å¤‡å°±ç»ª');
                });
            }

            applyJsonFromEditor() {
                const jsonEditor = document.getElementById('jsonEditor');
                try {
                    const newConfig = JSON.parse(jsonEditor.value);
                    
                    // æ ‡è®°ä¸ºä»JSONç¼–è¾‘å™¨æ›´æ–°ï¼Œé¿å…å¾ªç¯æ›´æ–°
                    this.isUpdatingFromJson = true;
                    
                    this.config = newConfig;
                    
                    // é‡æ–°åˆå§‹åŒ–å½“å‰æ­¥éª¤
                    this.currentStepIndex = Math.min(this.currentStepIndex, this.config.steps.length - 1);
                    if (this.currentStepIndex < 0 && this.config.steps.length > 0) {
                        this.currentStepIndex = 0;
                    }
                    
                    // æ›´æ–°å…¨å±€æ ‡é¢˜
                    document.getElementById('globalTitle').value = this.config.title || '';
                    
                    // é‡æ–°åŠ è½½å½“å‰æ­¥éª¤çš„å›¾ç‰‡
                    if (this.currentStepIndex >= 0 && this.config.steps[this.currentStepIndex]) {
                        const currentStep = this.config.steps[this.currentStepIndex];
                        if (currentStep.image) {
                            document.getElementById('imageUrl').value = currentStep.image;
                            this.loadImage();
                        } else {
                            document.getElementById('imageUrl').value = '';
                            this.displayChapterPage();
                        }
                    }
                    
                    // æ›´æ–°ç•Œé¢
                    this.updateCompactStepsList();
                    this.updatePreview();
                    
                    // é‡ç½®æ ‡è®°
                    this.isUpdatingFromJson = false;
                    
                    this.updateJsonStatus('âœ“ å·²åŒæ­¥', 'success');
                } catch (error) {
                    this.updateJsonStatus('âœ— JSONæ ¼å¼é”™è¯¯: ' + error.message, 'error');
                }
            }

            updateJsonStatus(message, type = 'info') {
                const statusEl = document.getElementById('jsonStatus');
                if (statusEl) {
                    statusEl.textContent = message;
                    
                    if (type === 'success') {
                        statusEl.style.color = '#28a745';
                    } else if (type === 'error') {
                        statusEl.style.color = '#dc3545';
                    } else {
                        statusEl.style.color = '#666';
                    }
                    
                    // å¦‚æœæ˜¯æˆåŠŸçŠ¶æ€ï¼Œ2ç§’åæ¢å¤é»˜è®¤
                    if (type === 'success') {
                        setTimeout(() => {
                            statusEl.textContent = 'å‡†å¤‡å°±ç»ª';
                            statusEl.style.color = '#666';
                        }, 2000);
                    }
                }
            }

            clearMarkers() {
                this.config.steps.forEach(step => {
                    delete step.button;
                });
                this.renderMarkers();
                this.updateCompactStepsList();
                this.updatePreview();
            }

            // === æ‹–æ‹½æ’åºåŠŸèƒ½ ===
            
            onStepDragStart(e, index) {
                this.draggedStepIndex = index;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', e.target.innerHTML);
                e.target.classList.add('dragging');
            }

            onStepDragOver(e, index) {
                if (e.preventDefault) {
                    e.preventDefault();
                }
                e.dataTransfer.dropEffect = 'move';
                return false;
            }

            onStepDragEnter(e) {
                e.target.closest('.step-item')?.classList.add('drag-over');
            }

            onStepDragLeave(e) {
                e.target.closest('.step-item')?.classList.remove('drag-over');
            }

            onStepDrop(e, dropIndex) {
                if (e.stopPropagation) {
                    e.stopPropagation();
                }
                
                const draggedIndex = this.draggedStepIndex;
                
                if (draggedIndex !== null && draggedIndex !== dropIndex) {
                    // ç§»åŠ¨æ­¥éª¤
                    const [movedStep] = this.config.steps.splice(draggedIndex, 1);
                    this.config.steps.splice(dropIndex, 0, movedStep);
                    
                    // æ›´æ–°å½“å‰é€‰ä¸­çš„ç´¢å¼•
                    if (this.currentStepIndex === draggedIndex) {
                        this.currentStepIndex = dropIndex;
                    } else if (draggedIndex < this.currentStepIndex && dropIndex >= this.currentStepIndex) {
                        this.currentStepIndex--;
                    } else if (draggedIndex > this.currentStepIndex && dropIndex <= this.currentStepIndex) {
                        this.currentStepIndex++;
                    }
                    
                    // æ›´æ–°é¢„è§ˆå½“å‰æ­¥éª¤
                    if (this.previewCurrentStep === draggedIndex) {
                        this.previewCurrentStep = dropIndex;
                    } else if (draggedIndex < this.previewCurrentStep && dropIndex >= this.previewCurrentStep) {
                        this.previewCurrentStep--;
                    } else if (draggedIndex > this.previewCurrentStep && dropIndex <= this.previewCurrentStep) {
                        this.previewCurrentStep++;
                    }
                    
                    this.updateCompactStepsList();
                    this.updatePreview();
                    this.updateJsonDisplay();
                }
                
                e.target.closest('.step-item')?.classList.remove('drag-over');
                return false;
            }

            onStepDragEnd(e) {
                e.target.classList.remove('dragging');
                // æ¸…é™¤æ‰€æœ‰drag-overç±»
                document.querySelectorAll('.step-item').forEach(item => {
                    item.classList.remove('drag-over');
                });
                this.draggedStepIndex = null;
            }

            // === æ·»åŠ ç« èŠ‚é¡µåŠŸèƒ½ ===
            
            addChapterStep() {
                const chapterNum = this.config.steps.filter(s => this.isChapterStep(s)).length + 1;
                const newChapter = {
                    id: `chapter-${chapterNum}`,
                    title: `ç« èŠ‚ ${chapterNum}`,
                    description: `ç« èŠ‚ ${chapterNum}`  // ä¿ç•™descriptionï¼Œä¸titleä¿æŒä¸€è‡´
                };
                
                this.config.steps.push(newChapter);
                const newIndex = this.config.steps.length - 1;
                this.selectCompactStep(newIndex);
                this.updateCompactStepsList();
                this.updatePreview();
                this.updateJsonDisplay();
            }

            // === é¢„è§ˆåŠŸèƒ½ç›¸å…³æ–¹æ³• ===

            updatePreview() {
                // æ›´æ–°é¢„è§ˆæ¼”ç¤º
                if (this.config.steps.length === 0) {
                    const previewDemo = document.getElementById('previewDemo');
                    previewDemo.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <p>æš‚æ— é¢„è§ˆå†…å®¹</p>
                            <small>æ·»åŠ æ­¥éª¤åä¼šæ˜¾ç¤ºé¢„è§ˆ</small>
                        </div>
                    `;
                    this.updatePreviewNavigation();
                    this.updateJsonDisplay();
                    return;
                }

                const previewDemo = document.getElementById('previewDemo');
                const currentStep = this.config.steps[this.previewCurrentStep];

                if (!currentStep) {
                    previewDemo.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <p>æ­¥éª¤ä¸å­˜åœ¨</p>
                        </div>
                    `;
                    this.updatePreviewNavigation();
                    this.updateJsonDisplay();
                    return;
                }

                // å¦‚æœæ˜¯ç« èŠ‚é¡µ
                if (this.isChapterStep(currentStep)) {
                    previewDemo.innerHTML = `
                        <div class="chapter-display" onclick="demoEditor.previewNextStep()" style="cursor: pointer; min-height: 300px;">
                            <div class="chapter-content">
                                <div class="chapter-number">${currentStep.id}</div>
                                <br>
                                <div class="chapter-title">${currentStep.title}</div>
                            </div>
                        </div>
                        <div class="preview-step-info">
                            <strong>ğŸ“ ${currentStep.title}</strong>
                            ${currentStep.description ? `<br><small class="text-muted">${currentStep.description}</small>` : ''}
                            ${currentStep.targetStepId ? `<br><small class="text-muted">â†’ ç›®æ ‡: ${currentStep.targetStepId}</small>` : ''}
                        </div>
                    `;
                } else if (!currentStep.image) {
                    previewDemo.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <p>å½“å‰æ­¥éª¤æ— å›¾ç‰‡</p>
                            <small>è¯·è®¾ç½®å›¾ç‰‡URL</small>
                        </div>
                    `;
                } else {
                    let buttonHtml = '';
                    if (currentStep.button && currentStep.button.position) {
                        // è®¡ç®—åç§»20pxï¼ˆå°æŒ‰é’®åŠå¾„ï¼‰ä½¿æŒ‰é’®ä¸­å¿ƒå¯¹å‡†ä½ç½®
                        let leftStyle = '';
                        let rightStyle = '';
                        if (currentStep.button.position.left) {
                            leftStyle = `left: calc(${currentStep.button.position.left} - 20px);`;
                        } else if (currentStep.button.position.right) {
                            rightStyle = `right: calc(${currentStep.button.position.right} - 20px);`;
                        }
                        const topStyle = `top: calc(${currentStep.button.position.top} - 20px);`;
                        
                        buttonHtml = `
                            <div class="demo-button" 
                                 style="${leftStyle}${rightStyle}${topStyle}" 
                                 onclick="demoEditor.previewNextStep()"
                                 data-balloon-pos="${currentStep.button.balloonPos}"
                                 aria-label="${currentStep.button.label}">
                                <svg width="40" height="40" viewBox="0 0 45 45" xmlns="http://www.w3.org/2000/svg" stroke="#fa541c">
                                    <g fill="none" fill-rule="evenodd" transform="translate(1 1)" stroke-width="2">
                                        <circle cx="22" cy="22" r="6" stroke-opacity="0">
                                            <animate attributeName="r" begin="1.5s" dur="3s" values="6;22" calcMode="linear" repeatCount="indefinite"/>
                                            <animate attributeName="stroke-opacity" begin="1.5s" dur="3s" values="1;0" calcMode="linear" repeatCount="indefinite"/>
                                            <animate attributeName="stroke-width" begin="1.5s" dur="3s" values="2;0" calcMode="linear" repeatCount="indefinite"/>
                                        </circle>
                                        <circle cx="22" cy="22" r="8">
                                            <animate attributeName="r" begin="0s" dur="1.5s" values="6;1;2;3;4;5;6" calcMode="linear" repeatCount="indefinite"/>
                                        </circle>
                                        <circle cx="22" cy="22" r="3" fill="#fa541c" stroke="none"/>
                                    </g>
                                </svg>
                            </div>
                        `;
                    }

                    previewDemo.innerHTML = `
                        <div class="preview-demo-container">
                            <img src="${currentStep.image}" onload="this.style.opacity=1" style="opacity:0.5; transition: opacity 0.3s; width: 100%; height: auto; border-radius: 4px;">
                            ${buttonHtml}
                        </div>
                        <div class="preview-step-info">
                            <strong>${currentStep.title}</strong>
                            ${currentStep.description ? `<br><small class="text-muted">${currentStep.description}</small>` : ''}
                        </div>
                    `;
                }

                this.updatePreviewNavigation();
                this.updateJsonDisplay();
            }

            updatePreviewNavigation() {
                const stepCounter = document.getElementById('stepCounter');
                const prevBtn = document.getElementById('prevStepBtn');
                const nextBtn = document.getElementById('nextStepBtn');

                const total = this.config.steps.length;
                const current = this.previewCurrentStep + 1;

                stepCounter.textContent = `${current} / ${total}`;
                
                prevBtn.disabled = this.previewCurrentStep <= 0;
                nextBtn.disabled = this.previewCurrentStep >= total - 1;
            }

            updateJsonDisplay() {
                // é¿å…å¾ªç¯æ›´æ–°ï¼šå¦‚æœæ­£åœ¨ä»JSONç¼–è¾‘å™¨æ›´æ–°ï¼Œè·³è¿‡
                if (this.isUpdatingFromJson) {
                    return;
                }
                
                const jsonEditor = document.getElementById('jsonEditor');
                if (jsonEditor) {
                    const jsonString = JSON.stringify(this.config, null, 2);
                    
                    // åªæœ‰å½“å†…å®¹çœŸçš„ä¸åŒæ—¶æ‰æ›´æ–°ï¼Œé¿å…å…‰æ ‡è·³åŠ¨
                    if (jsonEditor.value !== jsonString) {
                        const cursorPos = jsonEditor.selectionStart;
                        jsonEditor.value = jsonString;
                        
                        // å°è¯•æ¢å¤å…‰æ ‡ä½ç½®ï¼ˆåœ¨åˆç†èŒƒå›´å†…ï¼‰
                        if (cursorPos <= jsonString.length) {
                            jsonEditor.setSelectionRange(cursorPos, cursorPos);
                        }
                    }
                }
            }

            previewPrevStep() {
                if (this.previewCurrentStep > 0) {
                    this.previewCurrentStep--;
                    this.updatePreview();
                }
            }

            previewNextStep() {
                if (this.previewCurrentStep < this.config.steps.length - 1) {
                    this.previewCurrentStep++;
                    this.updatePreview();
                } else {
                    // å¾ªç¯å›ç¬¬ä¸€æ­¥
                    this.previewCurrentStep = 0;
                    this.updatePreview();
                }
            }

            // åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹çš„æ­¥éª¤è·³è½¬
            goToNextStep() {
                if (this.config.steps.length === 0) return;
                
                if (this.currentStepIndex < this.config.steps.length - 1) {
                    this.selectCompactStep(this.currentStepIndex + 1);
                } else {
                    // å¾ªç¯å›ç¬¬ä¸€æ­¥
                    this.selectCompactStep(0);
                }
            }

            // === å…¨å±é¢„è§ˆåŠŸèƒ½ ===

            openFullscreenPreview() {
                const overlay = document.getElementById('fullscreenOverlay');
                overlay.classList.add('active');
                
                // è®¾ç½®å…¨å±æ ‡é¢˜
                const titleEl = document.getElementById('fullscreenTitle');
                titleEl.textContent = this.config.title || 'Demo é¢„è§ˆ';
                
                // æ›´æ–°å…¨å±é¢„è§ˆå†…å®¹
                this.updateFullscreenPreview();
                
                // ç¦ç”¨é¡µé¢æ»šåŠ¨
                document.body.style.overflow = 'hidden';
            }

            closeFullscreenPreview() {
                const overlay = document.getElementById('fullscreenOverlay');
                overlay.classList.remove('active');
                
                // æ¢å¤é¡µé¢æ»šåŠ¨
                document.body.style.overflow = '';
            }

            fullscreenPrevStep() {
                if (this.previewCurrentStep > 0) {
                    this.previewCurrentStep--;
                    this.updateFullscreenPreview();
                }
            }

            fullscreenNextStep() {
                if (this.previewCurrentStep < this.config.steps.length - 1) {
                    this.previewCurrentStep++;
                    this.updateFullscreenPreview();
                } else {
                    // å¾ªç¯å›ç¬¬ä¸€æ­¥
                    this.previewCurrentStep = 0;
                    this.updateFullscreenPreview();
                }
            }

            updateFullscreenPreview() {
                if (this.config.steps.length === 0) {
                    const fullscreenDemo = document.getElementById('fullscreenDemo');
                    fullscreenDemo.innerHTML = `
                        <div style="text-align: center; padding: 80px 40px; color: #666;">
                            <h3 style="margin-bottom: 20px; color: #333;">æš‚æ— é¢„è§ˆå†…å®¹</h3>
                            <p>è¯·å…ˆæ·»åŠ æ­¥éª¤å¹¶é…ç½®å›¾ç‰‡</p>
                        </div>
                    `;
                    this.updateFullscreenNavigation();
                    return;
                }

                const currentStep = this.config.steps[this.previewCurrentStep];
                
                if (!currentStep) {
                    const fullscreenDemo = document.getElementById('fullscreenDemo');
                    fullscreenDemo.innerHTML = `
                        <div style="text-align: center; padding: 80px 40px; color: #666;">
                            <h3 style="margin-bottom: 20px; color: #333;">æ­¥éª¤ä¸å­˜åœ¨</h3>
                        </div>
                    `;
                    this.updateFullscreenNavigation();
                    return;
                }

                // å¦‚æœæ˜¯ç« èŠ‚é¡µ
                if (this.isChapterStep(currentStep)) {
                    const fullscreenDemo = document.getElementById('fullscreenDemo');
                    fullscreenDemo.innerHTML = `
                        <div class="fullscreen-demo-wrap">
                            <div class="fullscreen-demo-container">
                                <div class="chapter-display" style="height: 400px; border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); cursor: pointer;" onclick="demoEditor.fullscreenNextStep()">
                                    <div class="chapter-content">
                                        <div class="chapter-number" style="font-size: 96px;">${currentStep.id}</div>
                                        <br>
                                        <div class="chapter-title" style="font-size: 32px;">${currentStep.title}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="fullscreen-step-info">
                                <h3>ğŸ“ ${currentStep.title}</h3>
                                <p>${currentStep.description || ''}</p>
                            </div>
                        </div>
                    `;
                } else if (!currentStep.image) {
                    const fullscreenDemo = document.getElementById('fullscreenDemo');
                    fullscreenDemo.innerHTML = `
                        <div style="text-align: center; padding: 80px 40px; color: #666;">
                            <h3 style="margin-bottom: 20px; color: #333;">å½“å‰æ­¥éª¤æ— å›¾ç‰‡</h3>
                            <p>è¯·è®¾ç½®å›¾ç‰‡URL</p>
                        </div>
                    `;
                } else {
                    let buttonHtml = '';
                    if (currentStep.button && currentStep.button.position) {
                        // è®¡ç®—åç§»40pxï¼ˆæŒ‰é’®åŠå¾„ï¼‰ä½¿æŒ‰é’®ä¸­å¿ƒå¯¹å‡†ä½ç½®
                        let leftStyle = '';
                        let rightStyle = '';
                        if (currentStep.button.position.left) {
                            leftStyle = `left: calc(${currentStep.button.position.left} - 40px);`;
                        } else if (currentStep.button.position.right) {
                            rightStyle = `right: calc(${currentStep.button.position.right} - 40px);`;
                        }
                        const topStyle = `top: calc(${currentStep.button.position.top} - 40px);`;
                        
                        buttonHtml = `
                            <div class="fullscreen-demo-button" 
                                 style="${leftStyle}${rightStyle}${topStyle}"
                                 onclick="demoEditor.fullscreenNextStep()"
                                 data-balloon-pos="${currentStep.button.balloonPos}"
                                 aria-label="${currentStep.button.label}">
                                <svg width="80" height="80" viewBox="0 0 45 45" xmlns="http://www.w3.org/2000/svg" stroke="#fa541c">
                                    <g fill="none" fill-rule="evenodd" transform="translate(1 1)" stroke-width="2">
                                        <circle cx="22" cy="22" r="6" stroke-opacity="0">
                                            <animate attributeName="r" begin="1.5s" dur="3s" values="6;22" calcMode="linear" repeatCount="indefinite"/>
                                            <animate attributeName="stroke-opacity" begin="1.5s" dur="3s" values="1;0" calcMode="linear" repeatCount="indefinite"/>
                                            <animate attributeName="stroke-width" begin="1.5s" dur="3s" values="2;0" calcMode="linear" repeatCount="indefinite"/>
                                        </circle>
                                        <circle cx="22" cy="22" r="8">
                                            <animate attributeName="r" begin="0s" dur="1.5s" values="6;1;2;3;4;5;6" calcMode="linear" repeatCount="indefinite"/>
                                        </circle>
                                        <circle cx="22" cy="22" r="3" fill="#fa541c" stroke="none"/>
                                    </g>
                                </svg>
                            </div>
                        `;
                    }

                    const fullscreenDemo = document.getElementById('fullscreenDemo');
                    fullscreenDemo.innerHTML = `
                        <div class="fullscreen-demo-wrap">
                            <div class="fullscreen-demo-container">
                                <img src="${currentStep.image}" 
                                     onload="this.style.opacity=1" 
                                     style="opacity:0.5; transition: opacity 0.3s; width: 100%; border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.1);">
                                ${buttonHtml}
                            </div>
                            <div class="fullscreen-step-info">
                                <h3>${currentStep.title}</h3>
                                <p>${currentStep.description || ''}</p>
                            </div>
                        </div>
                    `;
                }

                this.updateFullscreenNavigation();
            }

            updateFullscreenNavigation() {
                const stepCounter = document.getElementById('fullscreenStepCounter');
                const prevBtn = document.getElementById('fullscreenPrevBtn');
                const nextBtn = document.getElementById('fullscreenNextBtn');

                const total = this.config.steps.length;
                const current = this.previewCurrentStep + 1;

                stepCounter.textContent = `${current} / ${total}`;
                
                prevBtn.disabled = this.previewCurrentStep <= 0;
                nextBtn.disabled = this.previewCurrentStep >= total - 1;
            }

            // === å¯¼å‡ºä¸ºç»„ä»¶åŠŸèƒ½ ===
            
            exportAsComponent() {
                // ç”Ÿæˆæ—¶é—´æˆ³å˜é‡å
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');
                const varName = `demo_${year}${month}${day}${hours}${minutes}${seconds}`;
                
                // è‡ªåŠ¨ä»æœ‰æ•ˆç« èŠ‚é¡µç”Ÿæˆ mainSteps
                const mainSteps = [];
                let stepNumber = 1;
                
                // æ‰¾å‡ºæ‰€æœ‰æœ‰æ•ˆçš„ç« èŠ‚é¡µï¼ˆä¸åŒ…æ‹¬intro/complete/finishä½†åŒ…æ‹¬chapter-Xï¼‰
                const validChapterSteps = this.config.steps.filter(step => {
                    if (!this.isChapterStep(step)) return false;
                    if (!step.id) return false;
                    
                    // è·³è¿‡ç‰¹æ®Šçš„ä»‹ç»å’Œç»“æŸç« èŠ‚ï¼Œä½†ä¿ç•™chapter-Xæ ¼å¼çš„ç« èŠ‚
                    const skipIds = ['intro', 'complete', 'finish', 'start', 'end'];
                    const shouldSkip = skipIds.some(skipId => 
                        step.id.toLowerCase() === skipId || 
                        step.id.toLowerCase().startsWith(skipId + '-') ||
                        step.id.toLowerCase().endsWith('-' + skipId)
                    );
                    
                    return !shouldSkip;
                });
                
                // ä¸ºæ¯ä¸ªæœ‰æ•ˆç« èŠ‚é¡µç”ŸæˆmainStepsæ¡ç›®
                validChapterSteps.forEach((step, index) => {
                    // ä½¿ç”¨ç« èŠ‚çš„æ ‡é¢˜æˆ–è‡ªåŠ¨ç”Ÿæˆ
                    const chapterTitle = step.title || `Chapter ${index + 1}`;
                    mainSteps.push({
                        number: String(stepNumber).padStart(2, '0'),
                        title: chapterTitle,
                        id: `guide${stepNumber}`,
                        targetStepId: step.id  // ç« èŠ‚é¡µæŒ‡å‘è‡ªå·±çš„ID
                    });
                    stepNumber++;
                });
                
                // ç”Ÿæˆå¯¼å‡ºé…ç½®
                const exportConfig = {
                    title: this.config.title || "",
                    subtitle: this.config.subtitle || "",
                    mainSteps: mainSteps,
                    steps: this.config.steps
                };
                
                // æ ¼å¼åŒ–JSONé…ç½®
                const jsonString = JSON.stringify(exportConfig, null, 2);
                
                // åˆ›å»ºæ¨¡æ€æ¡†æ˜¾ç¤ºä»£ç 
                this.showExportModal(jsonString, varName);
            }

            showExportModal(jsonString, varName) {
                // åˆ›å»ºæ¨¡æ€æ¡†è¦†ç›–å±‚
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.5);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;

                // åˆ›å»ºæ¨¡æ€æ¡†å†…å®¹
                const modalContent = document.createElement('div');
                modalContent.style.cssText = `
                    background: white;
                    padding: 25px;
                    border-radius: 10px;
                    max-width: 1000px;
                    width: 95%;
                    height: 90vh;
                    max-height: 800px;
                    display: flex;
                    flex-direction: column;
                    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
                `;

                // ç”Ÿæˆä¸¤éƒ¨åˆ†ä»£ç 
                const definitionCode = `const ${varName} = ${jsonString};`;
                const componentCode = `<InteractiveDemo guides={${varName}} />`;
                
                modalContent.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-shrink: 0;">
                        <h3 style="margin: 0; font-size: 20px; color: #333;">ğŸš€ å¯¼å‡ºä¸º Astro ç»„ä»¶</h3>
                        <button id="closeModalBtn" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">âœ• å…³é—­</button>
                    </div>
                    <div style="background: #f0f7ff; padding: 15px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #b8daff; flex-shrink: 0;">
                        <p style="margin: 0 0 8px 0; font-size: 14px; color: #004085; font-weight: 500;">ğŸ“Œ ä½¿ç”¨è¯´æ˜ï¼š</p>
                        <p style="margin: 0; font-size: 13px; color: #004085; line-height: 1.6;">
                            1. ç¡®ä¿å·²ç»å¯¼å…¥ InteractiveDemo ç»„ä»¶ï¼š<code style="background: white; padding: 2px 6px; border-radius: 3px; font-family: monospace;">import InteractiveDemo from '@components/InteractiveDemo.astro';</code><br>
                            2. å°†é…ç½®å®šä¹‰å¤åˆ¶åˆ° Astro é¡µé¢çš„ frontmatter éƒ¨åˆ†ï¼ˆ--- ä¹‹é—´ï¼‰<br>
                            3. å°†ç»„ä»¶ä½¿ç”¨ä»£ç å¤åˆ¶åˆ°é¡µé¢éœ€è¦å±•ç¤ºçš„ä½ç½®
                        </p>
                    </div>
                    <div style="flex: 1; min-height: 0; display: flex; gap: 15px; overflow: hidden;">
                        <div style="flex: 1; display: flex; flex-direction: column;">
                            <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #333; display: flex; align-items: center; gap: 8px;">
                                <span style="background: #007bff; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">Part 1</span>
                                é…ç½®å®šä¹‰
                                <span style="font-size: 12px; color: #666; font-weight: normal;">ï¼ˆå˜é‡å: ${varName}ï¼‰</span>
                            </h4>
                            <textarea id="definitionCode" style="flex: 1; width: 100%; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace; font-size: 12px; line-height: 1.5; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; background: #fafafa; resize: none; overflow: auto;" readonly>${definitionCode}</textarea>
                            <button id="copyDefinitionBtn" class="btn-success" style="margin-top: 10px; padding: 8px; font-size: 13px; border-radius: 4px;">ğŸ“‹ å¤åˆ¶é…ç½®å®šä¹‰</button>
                        </div>
                        <div style="flex: 0 0 350px; display: flex; flex-direction: column;">
                            <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #333; display: flex; align-items: center; gap: 8px;">
                                <span style="background: #28a745; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">Part 2</span>
                                ç»„ä»¶ä½¿ç”¨
                            </h4>
                            <textarea id="componentCode" style="flex: 0 0 100px; width: 100%; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace; font-size: 12px; line-height: 1.5; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; background: #fafafa; resize: none; overflow: auto;" readonly>${componentCode}</textarea>
                            <button id="copyComponentBtn" class="btn-success" style="margin-top: 10px; padding: 8px; font-size: 13px; border-radius: 4px;">ğŸ“‹ å¤åˆ¶ç»„ä»¶ä»£ç </button>
                            <div style="flex: 1; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px; border: 1px solid #dee2e6;">
                                <h5 style="margin: 0 0 10px 0; font-size: 13px; color: #495057;">ğŸ’¡ å®Œæ•´ç¤ºä¾‹ï¼š</h5>
                                <pre style="margin: 0; font-size: 11px; line-height: 1.4; color: #495057; font-family: monospace; white-space: pre-wrap; word-wrap: break-word;">---
import InteractiveDemo from '@components/InteractiveDemo.astro';

${definitionCode}
---

&lt;!-- é¡µé¢å†…å®¹ --&gt;
${componentCode}</pre>
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px; margin-top: 20px; flex-shrink: 0;">
                        <button id="copyAllBtn" class="btn-primary" style="flex: 1; padding: 12px; font-size: 14px; font-weight: 500; border-radius: 6px;">ğŸ“‹ å¤åˆ¶å…¨éƒ¨ä»£ç </button>
                        <button id="downloadCodeBtn" class="btn-primary" style="flex: 1; padding: 12px; font-size: 14px; font-weight: 500; border-radius: 6px;">ğŸ’¾ ä¸‹è½½ä¸ºæ–‡ä»¶</button>
                    </div>
                `;

                modal.appendChild(modalContent);
                document.body.appendChild(modal);

                // ç»‘å®šäº‹ä»¶
                document.getElementById('closeModalBtn').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });

                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                });

                // å¤åˆ¶åŠŸèƒ½è¾…åŠ©å‡½æ•°
                const copyToClipboard = (text, btnId) => {
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    textarea.style.position = 'fixed';
                    textarea.style.opacity = '0';
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    
                    // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
                    const btn = document.getElementById(btnId);
                    const originalText = btn.textContent;
                    btn.textContent = 'âœ“ å·²å¤åˆ¶!';
                    btn.style.background = '#28a745';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '';
                    }, 2000);
                };

                // å¤åˆ¶é…ç½®å®šä¹‰
                document.getElementById('copyDefinitionBtn').addEventListener('click', () => {
                    copyToClipboard(definitionCode, 'copyDefinitionBtn');
                });

                // å¤åˆ¶ç»„ä»¶ä»£ç 
                document.getElementById('copyComponentBtn').addEventListener('click', () => {
                    copyToClipboard(componentCode, 'copyComponentBtn');
                });

                // å¤åˆ¶å…¨éƒ¨ä»£ç 
                document.getElementById('copyAllBtn').addEventListener('click', () => {
                    const fullCode = `---
import InteractiveDemo from '@components/InteractiveDemo.astro';

${definitionCode}
---

<!-- é¡µé¢å†…å®¹ -->
${componentCode}`;
                    copyToClipboard(fullCode, 'copyAllBtn');
                });

                document.getElementById('downloadCodeBtn').addEventListener('click', () => {
                    const fullCode = `---
import InteractiveDemo from '@components/InteractiveDemo.astro';

${definitionCode}
---

<!-- é¡µé¢å†…å®¹ -->
${componentCode}`;
                    const blob = new Blob([fullCode], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `demo-config-${varName}.astro`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                });
            }
            
            // === è‡ªåŠ¨ä¿å­˜åŠŸèƒ½ ===
            
            startAutoSave() {
                // æ¯10ç§’è‡ªåŠ¨ä¿å­˜ä¸€æ¬¡
                this.autoSaveTimer = setInterval(() => {
                    this.autoSave();
                }, 10000);
            }
            
            stopAutoSave() {
                if (this.autoSaveTimer) {
                    clearInterval(this.autoSaveTimer);
                    this.autoSaveTimer = null;
                }
            }
            
            autoSave() {
                const currentConfig = JSON.stringify(this.config);
                
                // æ£€æŸ¥é…ç½®æ˜¯å¦æœ‰å˜åŒ–
                if (currentConfig !== this.lastSavedConfig) {
                    const saveItem = {
                        timestamp: new Date().toISOString(),
                        time: new Date().toLocaleString('zh-CN'),
                        config: this.config
                    };
                    
                    // æ·»åŠ åˆ°å†å²è®°å½•
                    this.saveHistory.unshift(saveItem);
                    
                    // æœ€å¤šä¿å­˜100æ¡è®°å½•
                    if (this.saveHistory.length > 100) {
                        this.saveHistory = this.saveHistory.slice(0, 100);
                    }
                    
                    // ä¿å­˜åˆ°localStorage
                    try {
                        localStorage.setItem('demoConfigHistory', JSON.stringify(this.saveHistory));
                        this.lastSavedConfig = currentConfig;
                        this.showSaveStatus('å·²è‡ªåŠ¨ä¿å­˜');
                    } catch (e) {
                        console.error('ä¿å­˜å¤±è´¥:', e);
                    }
                }
            }
            
            loadSaveHistory() {
                try {
                    const saved = localStorage.getItem('demoConfigHistory');
                    if (saved) {
                        this.saveHistory = JSON.parse(saved);
                        // ä¸å†è‡ªåŠ¨è¯¢é—®æ¢å¤
                    }
                } catch (e) {
                    console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', e);
                    this.saveHistory = [];
                }
            }
            
            showSaveStatus(message) {
                // æ˜¾ç¤ºä¿å­˜çŠ¶æ€
                const statusDiv = document.getElementById('saveStatus') || this.createSaveStatusDiv();
                statusDiv.textContent = message + ' ' + new Date().toLocaleTimeString('zh-CN');
                statusDiv.style.opacity = '1';
                
                setTimeout(() => {
                    statusDiv.style.opacity = '0.5';
                }, 2000);
            }
            
            createSaveStatusDiv() {
                const statusDiv = document.createElement('div');
                statusDiv.id = 'saveStatus';
                statusDiv.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    background: #28a745;
                    color: white;
                    padding: 8px 16px;
                    border-radius: 4px;
                    font-size: 12px;
                    opacity: 0.5;
                    transition: opacity 0.3s;
                    z-index: 1000;
                `;
                document.body.appendChild(statusDiv);
                return statusDiv;
            }
            
            showHistory() {
                const modal = document.getElementById('historyModal');
                const list = document.getElementById('historyList');
                
                if (this.saveHistory.length === 0) {
                    list.innerHTML = '<p style="text-align: center; color: #999;">æš‚æ— ä¿å­˜è®°å½•</p>';
                } else {
                    list.innerHTML = this.saveHistory.map((item, index) => `
                        <div style="padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s;"
                             onmouseover="this.style.background='#f5f5f5'"
                             onmouseout="this.style.background=''"
                             onclick="demoEditor.loadHistory(${index})">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>ä¿å­˜æ—¶é—´ï¼š${item.time}</strong>
                                    <div style="color: #666; font-size: 12px; margin-top: 4px;">
                                        æ­¥éª¤æ•°ï¼š${item.config.steps ? item.config.steps.length : 0} | 
                                        æ ‡é¢˜ï¼š${item.config.title || 'æœªå‘½å'}
                                    </div>
                                </div>
                                <button onclick="event.stopPropagation(); demoEditor.deleteHistory(${index})" 
                                        style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">
                                    åˆ é™¤
                                </button>
                            </div>
                        </div>
                    `).join('');
                }
                
                modal.style.display = 'block';
            }
            
            loadHistory(index) {
                if (index >= 0 && index < this.saveHistory.length) {
                    if (confirm('ç¡®å®šè¦åŠ è½½è¿™ä¸ªå†å²è®°å½•å—ï¼Ÿå½“å‰çš„ç¼–è¾‘å†…å®¹å°†è¢«æ›¿æ¢ã€‚')) {
                        this.config = JSON.parse(JSON.stringify(this.saveHistory[index].config));
                        this.lastSavedConfig = JSON.stringify(this.config);
                        this.updateCompactStepsList();
                        this.updateJsonDisplay();
                        this.updatePreview();
                        
                        // å¦‚æœæœ‰æ­¥éª¤ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ª
                        if (this.config.steps && this.config.steps.length > 0) {
                            this.selectCompactStep(0);
                        }
                        
                        document.getElementById('historyModal').style.display = 'none';
                        this.showSaveStatus('å·²åŠ è½½å†å²è®°å½•');
                    }
                }
            }
            
            deleteHistory(index) {
                if (index >= 0 && index < this.saveHistory.length) {
                    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å†å²è®°å½•å—ï¼Ÿ')) {
                        this.saveHistory.splice(index, 1);
                        localStorage.setItem('demoConfigHistory', JSON.stringify(this.saveHistory));
                        this.showHistory(); // åˆ·æ–°åˆ—è¡¨
                    }
                }
            }
            
            clearHistory() {
                if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                    this.saveHistory = [];
                    localStorage.removeItem('demoConfigHistory');
                    this.showHistory(); // åˆ·æ–°åˆ—è¡¨
                }
            }
        }

        // å…¨å±€å¼•ç”¨ï¼Œç”¨äºé¢„è§ˆä¸­çš„æŒ‰é’®ç‚¹å‡»
        let demoEditor;

        // åˆå§‹åŒ–ç¼–è¾‘å™¨
        document.addEventListener('DOMContentLoaded', () => {
            demoEditor = new DemoConfigEditor();
        });
    </script>
</body>
</html> 